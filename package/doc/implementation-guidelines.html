<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.2">
    <meta name="project" content="ex_esdb v0.6.0">


    <title>Implementation Guidelines — ex_esdb v0.6.0</title>

    <link rel="stylesheet" href="dist/html-elixir-KV3YOVJ3.css" />

      <link rel="canonical" href="https://hexdocs.pm/ex_esdb/implementation-guidelines.html" />

    <script defer src="dist/sidebar_items-87CD0C4F.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

      <div>
        <a href="readme.html" class="sidebar-projectName" translate="no">
ex_esdb
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.6.0
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras="guides"></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of ex_esdb</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>General Implementation Guidelines for Reckon_* Applications</h1>


  </div>


<h2 id="introduction-why-vertical-slicing-and-screaming-architecture" class="section-heading"><a href="#introduction-why-vertical-slicing-and-screaming-architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Introduction: Why Vertical Slicing and Screaming Architecture?</span></h2><p>Traditional layered architectures organize code by <strong>technical concerns</strong>—controllers, services, repositories, models. This approach creates several problems:</p><h3 id="problems-with-layered-architecture" class="section-heading"><a href="#problems-with-layered-architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Problems with Layered Architecture</span></h3><ol><li><strong>Scattered Business Logic</strong>: A single business operation spans multiple layers and directories</li><li><strong>Cognitive Overhead</strong>: Developers must navigate between layers to understand one feature</li><li><strong>Tight Coupling</strong>: Changes often require modifications across multiple layers</li><li><strong>Testing Complexity</strong>: Integration tests become necessary to verify simple business operations</li><li><strong>Team Conflicts</strong>: Multiple developers working on the same layers create merge conflicts</li><li><strong>Hidden Business Intent</strong>: The codebase doesn't reveal what the system actually does</li></ol><h3 id="why-we-chose-vertical-slicing" class="section-heading"><a href="#why-we-chose-vertical-slicing" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Why We Chose Vertical Slicing</span></h3><p><strong>Vertical slicing</strong> organizes code by <strong>business capabilities</strong> instead of technical layers. Each business operation becomes a self-contained &quot;slice&quot; with everything it needs:</p><ul><li><strong>Single Source of Truth</strong>: All code for one business operation lives together</li><li><strong>Reduced Cognitive Load</strong>: Developers see the complete feature in one place</li><li><strong>Independent Evolution</strong>: Features can change without affecting others</li><li><strong>Simplified Testing</strong>: Each slice can be tested in isolation</li><li><strong>Team Autonomy</strong>: Different teams can own different slices</li><li><strong>Business Alignment</strong>: Code structure mirrors how the business thinks</li></ul><h3 id="why-we-chose-screaming-architecture" class="section-heading"><a href="#why-we-chose-screaming-architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Why We Chose Screaming Architecture</span></h3><p><strong>Screaming Architecture</strong> (Uncle Bob's term) means your codebase &quot;screams&quot; its business intent. When someone looks at the folder structure, they immediately understand:</p><ul><li><strong>What the system does</strong> (not how it's implemented)</li><li><strong>What business operations exist</strong> (initialize_account, cast_vote)</li><li><strong>What the domain is about</strong> (voting, accounts, profiles)</li></ul><p>Instead of seeing generic technical folders like <code class="inline">controllers/</code>, <code class="inline">services/</code>, <code class="inline">models/</code>, you see business-focused folders like <code class="inline">initialize_poll/</code>, <code class="inline">cast_vote/</code>, <code class="inline">activate_account/</code>.</p><h3 id="real-world-benefits" class="section-heading"><a href="#real-world-benefits" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Real-World Benefits</span></h3><p>This architecture has proven benefits in production systems:</p><ul><li><strong>Faster Onboarding</strong>: New developers understand the system quickly</li><li><strong>Reduced Bugs</strong>: Business logic stays cohesive and isolated</li><li><strong>Better Documentation</strong>: The code structure IS the documentation</li><li><strong>Easier Refactoring</strong>: Changes are localized to specific slices</li><li><strong>Business Conversations</strong>: Non-technical stakeholders can navigate the codebase</li></ul><h2 id="architecture-philosophy" class="section-heading"><a href="#architecture-philosophy" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Architecture Philosophy</span></h2><h3 id="vertical-slicing-architecture" class="section-heading"><a href="#vertical-slicing-architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Vertical Slicing Architecture</span></h3><p>The reckon_<em> applications follow a <em>*vertical slicing architecture</em></em> where each business operation (use case) is implemented as a self-contained slice that includes all necessary components:</p><ul><li><strong>Command</strong>: Input structure defining the operation</li><li><strong>Event</strong>: Output structure representing what happened</li><li><strong>Handler</strong>: Business logic processing the command and emitting events</li><li><strong>Projections</strong>: Read models updated by events (when needed)</li></ul><p>This approach ensures that each business capability is:</p><ul><li><strong>Isolated</strong>: Changes to one slice don't affect others</li><li><strong>Cohesive</strong>: All related code is co-located</li><li><strong>Testable</strong>: Each slice can be tested independently</li><li><strong>Discoverable</strong>: Business operations are obvious from the folder structure</li></ul><h3 id="screaming-architecture" class="section-heading"><a href="#screaming-architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Screaming Architecture</span></h3><p>The codebase &quot;screams&quot; its business intent through:</p><ol><li><strong>Directory Structure</strong>: Business operations are immediately visible as top-level folders</li><li><strong>Module Names</strong>: Clearly express business concepts, not technical layers</li><li><strong>File Organization</strong>: Business logic is organized by use case, not by technical pattern</li></ol><h2 id="mandatory-event-storming-requirement" class="section-heading"><a href="#mandatory-event-storming-requirement" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">🔥 MANDATORY Event Storming Requirement</span></h2><p><strong>RULE</strong>: Each new project MUST start with an initial Event Storming session, of which the result will be written in the apps <code class="inline">./design_docs/event-storming.md</code> document.</p><p>This document is a timestamped log of event storming sessions and will contain the following sections:</p><ol><li><strong>Executive Summary</strong> (a description of the process under design)</li><li><strong>ASCII diagram</strong> that depicts the commands, the policies they are called from, the events they emit</li><li><strong>ASCII code structure diagram</strong></li><li><strong>Description of each slice</strong></li></ol><p>The event storming document serves as the foundation for implementing the vertical slicing architecture and ensures all stakeholders understand the business processes before development begins.</p><h2 id="strict-versioning-rules" class="section-heading"><a href="#strict-versioning-rules" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">🔥 STRICT VERSIONING RULES</span></h2><p><strong>These rules are MANDATORY and MUST be followed without exception:</strong></p><h3 id="1-all-commands-and-events-must-have-versions" class="section-heading"><a href="#1-all-commands-and-events-must-have-versions" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">1. All Commands and Events MUST Have Versions</span></h3><ul><li><strong>Commands</strong>: <code class="inline">InitializePollV1</code>, <code class="inline">CastVoteV1</code></li><li><strong>Events</strong>: <code class="inline">PollInitializedV1</code>, <code class="inline">VoteCastedV1</code></li><li><strong>Event Type Strings</strong>: <code class="inline">&quot;poll_initialized:v1&quot;</code>, <code class="inline">&quot;vote_casted:v1&quot;</code></li></ul><h3 id="2-directory-names-are-clean-no-version-suffix" class="section-heading"><a href="#2-directory-names-are-clean-no-version-suffix" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">2. Directory Names Are Clean (No Version Suffix)</span></h3><ul><li><strong>Format</strong>: <code class="inline">[command_name]/</code> (no version in directory name)</li><li><strong>Examples</strong>: <code class="inline">initialize_poll/</code>, <code class="inline">cast_vote/</code>, <code class="inline">activate_account/</code></li><li><strong>Rationale</strong>: Prevents unwieldy module names like <code class="inline">InitializePollV1.CommandV1</code></li></ul><h3 id="3-file-names-must-include-version" class="section-heading"><a href="#3-file-names-must-include-version" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">3. File Names MUST Include Version</span></h3><ul><li><strong>Files</strong>: <code class="inline">command_v1.ex</code>, <code class="inline">event_v1.ex</code>, <code class="inline">maybe_initialize_poll_v1.ex</code></li><li><strong>Event Handlers</strong>: <code class="inline">initialized_to_state_v1.ex</code>, <code class="inline">casted_to_summary_v1.ex</code></li><li><strong>Projections</strong>: <code class="inline">initialized_to_summary_v1.ex</code></li><li><strong>Evolution</strong>: V2 files coexist in same directory: <code class="inline">command_v2.ex</code>, <code class="inline">event_v2.ex</code></li></ul><h3 id="4-forbidden-crud-events" class="section-heading"><a href="#4-forbidden-crud-events" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">4. 🚫 FORBIDDEN: CRUD Events</span></h3><p><strong>CRUD events have NO business meaning and are STRICTLY FORBIDDEN:</strong></p><p><strong>❌ FORBIDDEN CRUD Events:</strong></p><ul><li><code class="inline">PollCreated</code>, <code class="inline">AccountUpdated</code>, <code class="inline">UserDeleted</code></li><li><code class="inline">ProfileCreated</code>, <code class="inline">MembershipUpdated</code></li><li>Any event ending in <code class="inline">-Created</code>, <code class="inline">-Updated</code>, <code class="inline">-Deleted</code></li></ul><p><strong>✅ REQUIRED: Business-Meaningful Events:</strong></p><ul><li><code class="inline">PollInitialized</code>, <code class="inline">AccountActivated</code>, <code class="inline">UserSuspended</code></li><li><code class="inline">ProfileEstablished</code>, <code class="inline">MembershipGranted</code>, <code class="inline">MembershipExpired</code></li><li>Events that express <strong>business intent and meaning</strong></li></ul><h2 id="project-structure" class="section-heading"><a href="#project-structure" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Project Structure</span></h2><pre><code class="makeup elixir" translate="no"><span class="n">reckon_</span><span class="p" data-group-id="2977470410-1">[</span><span class="n">domain</span><span class="p" data-group-id="2977470410-1">]</span><span class="o">/</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">lib</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">reckon_</span><span class="p" data-group-id="2977470410-2">[</span><span class="n">domain</span><span class="p" data-group-id="2977470410-2">]</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">application</span><span class="o">.</span><span class="n">ex</span><span class="w">           </span><span class="c1"># OTP application bootstrap</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">repo</span><span class="o">.</span><span class="n">ex</span><span class="w">                  </span><span class="c1"># Ecto repository for read models</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">router</span><span class="o">.</span><span class="n">ex</span><span class="w">                </span><span class="c1"># Commanded router for command dispatch</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">shared</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="2977470410-3">[</span><span class="n">aggregate</span><span class="p" data-group-id="2977470410-3">]</span><span class="o">.</span><span class="n">ex</span><span class="w">       </span><span class="c1"># Domain aggregate root</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">domain</span><span class="o">/</span><span class="w">                  </span><span class="c1"># 🔥 LITERAL &quot;domain&quot; directory (invariant)</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="2977470410-4">[</span><span class="n">command_name</span><span class="p" data-group-id="2977470410-4">]</span><span class="o">/</span><span class="w">      </span><span class="c1"># 🔥 VERTICAL SLICE (named after COMMAND)</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">command</span><span class="o">.</span><span class="n">ex</span><span class="w">       </span><span class="c1"># Command structure (input)</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">ex</span><span class="w">         </span><span class="c1"># Event structure (output)</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">handler</span><span class="o">.</span><span class="n">ex</span><span class="w">       </span><span class="c1"># Command handler (business logic)</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="2977470410-5">[</span><span class="n">event</span><span class="p" data-group-id="2977470410-5">]</span><span class="c">_to_state</span><span class="o">.</span><span class="n">ex</span><span class="w">                    </span><span class="c1"># Event handler (aggregate updates)</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="2977470410-6">[</span><span class="n">event</span><span class="p" data-group-id="2977470410-6">]</span><span class="c">_to_</span><span class="p" data-group-id="2977470410-7">[</span><span class="n">readmodel</span><span class="p" data-group-id="2977470410-7">]</span><span class="o">.</span><span class="n">ex</span><span class="w">              </span><span class="c1"># Projection (optional)</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">when_</span><span class="p" data-group-id="2977470410-8">[</span><span class="n">event</span><span class="p" data-group-id="2977470410-8">]</span><span class="c">_then_</span><span class="p" data-group-id="2977470410-9">[</span><span class="n">command</span><span class="p" data-group-id="2977470410-9">]</span><span class="o">.</span><span class="n">ex</span><span class="w">         </span><span class="c1"># Policy (optional)</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="2977470410-10">[</span><span class="n">another_command</span><span class="p" data-group-id="2977470410-10">]</span><span class="o">/</span><span class="w">   </span><span class="c1"># Another vertical slice</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">command</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">handler</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="2977470410-11">[</span><span class="n">event</span><span class="p" data-group-id="2977470410-11">]</span><span class="c">_to_state</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">       </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">...</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">projections</span><span class="o">/</span><span class="w">             </span><span class="c1"># Cross-cutting read models (if needed)</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">       </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="2977470410-12">[</span><span class="n">projection_name</span><span class="p" data-group-id="2977470410-12">]</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">reckon_</span><span class="p" data-group-id="2977470410-13">[</span><span class="n">domain</span><span class="p" data-group-id="2977470410-13">]</span><span class="o">.</span><span class="n">ex</span><span class="w">           </span><span class="c1"># Public API (business facade)</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">mix</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">tasks</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">           </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">reckon_</span><span class="p" data-group-id="2977470410-14">[</span><span class="n">domain</span><span class="p" data-group-id="2977470410-14">]</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">           </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">reckon_</span><span class="p" data-group-id="2977470410-15">[</span><span class="n">domain</span><span class="p" data-group-id="2977470410-15">]</span><span class="o">.</span><span class="n">reset</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">config</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">config</span><span class="o">.</span><span class="n">exs</span><span class="w">                   </span><span class="c1"># Main config with ExESDB setup</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">dev</span><span class="o">.</span><span class="n">exs</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">test</span><span class="o">.</span><span class="n">exs</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">prod</span><span class="o">.</span><span class="n">exs</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">test</span><span class="o">/</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">priv</span><span class="o">/</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">mix</span><span class="o">.</span><span class="n">exs</span></code></pre><h2 id="core-principles" class="section-heading"><a href="#core-principles" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Core Principles</span></h2><h3 id="1-one-capability-per-module-strategy" class="section-heading"><a href="#1-one-capability-per-module-strategy" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">1. One Capability Per Module Strategy</span></h3><p><strong>FUNDAMENTAL RULE</strong>: We follow a strict 1-capability-per-module strategy across all components:</p><ul><li><strong>1 Command per Module</strong>: Each command gets its own dedicated module</li><li><strong>1 Event per Module</strong>: Each event gets its own dedicated module  </li><li><strong>1 Handler per Module</strong>: Each handler processes one command type</li><li><strong>1 Projection per Module</strong>: Each projection handles one event type to one read model</li><li><strong>1 Policy per Module</strong>: Each policy (process manager) handles one event-to-command translation</li></ul><p>This ensures maximum cohesion, testability, and discoverability.</p><h3 id="2-each-command-event-must-reside-in-its-own-module" class="section-heading"><a href="#2-each-command-event-must-reside-in-its-own-module" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">2. Each Command/Event Must Reside in Its Own Module</span></h3><p><strong>❌ WRONG - Grouping multiple commands/events in one module:</strong></p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ReckonProfiles.Commands</span><span class="w"> </span><span class="k" data-group-id="9256334725-1">do</span><span class="w">
  </span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">CreateProfile</span><span class="w"> </span><span class="k" data-group-id="9256334725-2">do</span><span class="w">
    </span><span class="c1"># ...</span><span class="w">
  </span><span class="k" data-group-id="9256334725-2">end</span><span class="w">
  
  </span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">UpdateProfile</span><span class="w"> </span><span class="k" data-group-id="9256334725-3">do</span><span class="w">
    </span><span class="c1"># ...</span><span class="w">
  </span><span class="k" data-group-id="9256334725-3">end</span><span class="w">
</span><span class="k" data-group-id="9256334725-1">end</span></code></pre><p><strong>✅ CORRECT - Each command/event in its own dedicated module:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># lib/reckon_profiles/create_profile/command.ex</span><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ReckonProfiles.CreateProfile.Command</span><span class="w"> </span><span class="k" data-group-id="1375211133-1">do</span><span class="w">
  </span><span class="c1"># ...</span><span class="w">
</span><span class="k" data-group-id="1375211133-1">end</span><span class="w">

</span><span class="c1"># lib/reckon_profiles/update_profile/command.ex</span><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ReckonProfiles.UpdateProfile.Command</span><span class="w"> </span><span class="k" data-group-id="1375211133-2">do</span><span class="w">
  </span><span class="c1"># ...</span><span class="w">
</span><span class="k" data-group-id="1375211133-2">end</span></code></pre><h3 id="3-vertical-slice-structure" class="section-heading"><a href="#3-vertical-slice-structure" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">3. Vertical Slice Structure</span></h3><p>Each business operation follows this exact pattern:</p><pre><code class="makeup elixir" translate="no"><span class="n">domain</span><span class="o">/</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="0404871008-1">[</span><span class="n">command_name</span><span class="p" data-group-id="0404871008-1">]</span><span class="o">/</span><span class="w">                      </span><span class="c1"># 🔥 SLICE named after COMMAND (no version)</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">command_v1</span><span class="o">.</span><span class="n">ex</span><span class="w">                    </span><span class="c1"># Input structure - what the user wants to do</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">event_v1</span><span class="o">.</span><span class="n">ex</span><span class="w">                      </span><span class="c1"># Output structure - what actually happened</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">maybe_</span><span class="p" data-group-id="0404871008-2">[</span><span class="n">command</span><span class="p" data-group-id="0404871008-2">]</span><span class="c">_v1</span><span class="o">.</span><span class="n">ex</span><span class="w">            </span><span class="c1"># Command handler - business logic</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="0404871008-3">[</span><span class="n">event</span><span class="p" data-group-id="0404871008-3">]</span><span class="c">_to_state_v1</span><span class="o">.</span><span class="n">ex</span><span class="w">           </span><span class="c1"># Event handler - aggregate state updates</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="0404871008-4">[</span><span class="n">event</span><span class="p" data-group-id="0404871008-4">]</span><span class="c">_to_</span><span class="p" data-group-id="0404871008-5">[</span><span class="n">readmodel</span><span class="p" data-group-id="0404871008-5">]</span><span class="c">_v1</span><span class="o">.</span><span class="n">ex</span><span class="w">     </span><span class="c1"># Projection (optional)</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">when_</span><span class="p" data-group-id="0404871008-6">[</span><span class="n">event</span><span class="p" data-group-id="0404871008-6">]</span><span class="c">_then_</span><span class="p" data-group-id="0404871008-7">[</span><span class="n">command</span><span class="p" data-group-id="0404871008-7">]</span><span class="c">_v1</span><span class="o">.</span><span class="n">ex</span><span class="w"> </span><span class="c1"># Policy (optional)</span><span class="w">
    </span><span class="err">│</span><span class="w">
    </span><span class="c1"># V2 Evolution (coexists in same directory)</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">command_v2</span><span class="o">.</span><span class="n">ex</span><span class="w">                    </span><span class="c1"># Updated command structure</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">event_v2</span><span class="o">.</span><span class="n">ex</span><span class="w">                      </span><span class="c1"># Updated event structure</span><span class="w">
    </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">maybe_</span><span class="p" data-group-id="0404871008-8">[</span><span class="n">command</span><span class="p" data-group-id="0404871008-8">]</span><span class="c">_v2</span><span class="o">.</span><span class="n">ex</span><span class="w">            </span><span class="c1"># Updated command handler</span></code></pre><p><strong>Key Points:</strong></p><ul><li>All slices go under the literal <code class="inline">domain/</code> directory</li><li>Slices are named after the <strong>command</strong> they contain (not the business operation)</li><li><code class="inline">maybe_[command].ex</code> = <strong>Command Handler</strong> (processes commands, emits events)</li><li><code class="inline">[event]_to_state.ex</code> = <strong>Event Handler</strong> (applies events to aggregate state)</li><li>Policies go in the slice where the <strong>command</strong> they trigger is located</li></ul><h3 id="4-strict-projection-naming-convention" class="section-heading"><a href="#4-strict-projection-naming-convention" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">4. Strict Projection Naming Convention</span></h3><p><strong>MANDATORY FORMAT</strong>: Projections MUST be named using the exact format <code class="inline">&lt;event&gt;_to_&lt;readmodel&gt;.ex</code></p><p><strong>Rules:</strong></p><ul><li>Projections belong in the same slice as the event they process</li><li>File name format: <code class="inline">[lowercase_event_name]_to_[readmodel_name].ex</code></li><li>Module name format: <code class="inline">Domain.BusinessOperation.EventToReadmodel</code></li><li>Each projection handles exactly ONE event type to ONE read model</li></ul><p><strong>Examples:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># File: lib/reckon_accounts/initialize_account/initialized_to_summary.ex</span><span class="w">
</span><span class="c1"># Module: ReckonAccounts.InitializeAccount.InitializedToSummary</span><span class="w">
</span><span class="c1"># Processes: AccountInitialized → AccountSummary</span><span class="w">

</span><span class="c1"># File: lib/reckon_profiles/establish_profile/established_to_directory.ex</span><span class="w">
</span><span class="c1"># Module: ReckonProfiles.EstablishProfile.EstablishedToDirectory</span><span class="w">
</span><span class="c1"># Processes: ProfileEstablished → ProfileDirectory</span></code></pre><h3 id="5-policy-process-manager-pattern" class="section-heading"><a href="#5-policy-process-manager-pattern" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">5. Policy (Process Manager) Pattern</span></h3><p><strong>Purpose</strong>: Policies translate events into commands and dispatch them through CommandedApp.</p><p><strong>Rules:</strong></p><ul><li>Policies belong in the slice where the <strong>command</strong> they trigger is located</li><li>File name format: <code class="inline">when_&lt;event&gt;_then_&lt;command&gt;.ex</code></li><li>Module name format: <code class="inline">Domain.CommandName.When&lt;Event&gt;Then&lt;Command&gt;</code></li><li>Each policy handles ONE event type and dispatches ONE command type</li><li><strong>MANDATORY</strong>: All command dispatching MUST go through <code class="inline">CommandedApp.dispatch/1</code></li></ul><p><strong>Policy Structure:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># File: lib/reckon_profiles/domain/establish_profile/when_account_activated_then_establish_profile.ex</span><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ReckonProfiles.Domain.EstablishProfile.WhenAccountActivatedThenEstablishProfile</span><span class="w"> </span><span class="k" data-group-id="6157214669-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Policy that triggers profile establishment when an account is activated.
  
  This policy listens to AccountActivated events and automatically
  dispatches an EstablishProfile command to the profiles domain.
  &quot;&quot;&quot;</span><span class="w">
  
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Commanded.Event.Handler</span><span class="p">,</span><span class="w">
    </span><span class="ss">application</span><span class="p">:</span><span class="w"> </span><span class="nc">ReckonProfiles.CommandedApp</span><span class="p">,</span><span class="w">
    </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;when_account_activated_then_establish_profile&quot;</span><span class="w">
  
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">ReckonAccounts.Domain.ActivateAccount.Event</span><span class="p">,</span><span class="w"> </span><span class="ss">as</span><span class="p">:</span><span class="w"> </span><span class="nc">AccountActivated</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">ReckonProfiles.Domain.EstablishProfile.Command</span><span class="p">,</span><span class="w"> </span><span class="ss">as</span><span class="p">:</span><span class="w"> </span><span class="nc">EstablishProfileCommand</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">ReckonProfiles.CommandedApp</span><span class="w">
  
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle</span><span class="p" data-group-id="6157214669-2">(</span><span class="p" data-group-id="6157214669-3">%</span><span class="nc" data-group-id="6157214669-3">AccountActivated</span><span class="p" data-group-id="6157214669-3">{</span><span class="p" data-group-id="6157214669-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="c">_metadata</span><span class="p" data-group-id="6157214669-2">)</span><span class="w"> </span><span class="k" data-group-id="6157214669-4">do</span><span class="w">
    </span><span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6157214669-5">%</span><span class="nc" data-group-id="6157214669-5">EstablishProfileCommand</span><span class="p" data-group-id="6157214669-5">{</span><span class="w">
      </span><span class="ss">account_id</span><span class="p">:</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">account_id</span><span class="p">,</span><span class="w">
      </span><span class="ss">email</span><span class="p">:</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">email</span><span class="p">,</span><span class="w">
      </span><span class="ss">requested_at</span><span class="p">:</span><span class="w"> </span><span class="nc">DateTime</span><span class="o">.</span><span class="n">utc_now</span><span class="p" data-group-id="6157214669-6">(</span><span class="p" data-group-id="6157214669-6">)</span><span class="w">
    </span><span class="p" data-group-id="6157214669-5">}</span><span class="w">
    
    </span><span class="c1"># MANDATORY: Dispatch through CommandedApp</span><span class="w">
    </span><span class="nc">CommandedApp</span><span class="o">.</span><span class="n">dispatch</span><span class="p" data-group-id="6157214669-7">(</span><span class="n">command</span><span class="p" data-group-id="6157214669-7">)</span><span class="w">
  </span><span class="k" data-group-id="6157214669-4">end</span><span class="w">
</span><span class="k" data-group-id="6157214669-1">end</span></code></pre><p><strong>Key Policy Placement Rule:</strong></p><ul><li>The policy goes in the slice of the <strong>command</strong> it triggers, not the event it listens to</li><li>This makes sense because the policy is about <strong>causing</strong> that command to be executed</li></ul><h2 id="concrete-examples" class="section-heading"><a href="#concrete-examples" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Concrete Examples</span></h2><p>To make the new structure crystal clear, here are concrete examples:</p><h3 id="example-reckonprofiles-domain-structure" class="section-heading"><a href="#example-reckonprofiles-domain-structure" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Example: ReckonProfiles Domain Structure</span></h3><pre><code class="makeup elixir" translate="no"><span class="n">reckon_profiles</span><span class="o">/</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">lib</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">reckon_profiles</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">application</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">repo</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">router</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">shared</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">profile</span><span class="o">.</span><span class="n">ex</span><span class="w">                        </span><span class="c1"># Profile aggregate</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">domain</span><span class="o">/</span><span class="w">                              </span><span class="c1"># 🔥 LITERAL &quot;domain&quot; directory</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">establish_profile</span><span class="o">/</span><span class="w">              </span><span class="c1"># Command slice</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">command</span><span class="o">.</span><span class="n">ex</span><span class="w">                   </span><span class="c1"># EstablishProfile command</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">ex</span><span class="w">                     </span><span class="c1"># ProfileEstablished event</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">handler</span><span class="o">.</span><span class="n">ex</span><span class="w">                   </span><span class="c1"># Command handler</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">established_to_state</span><span class="o">.</span><span class="n">ex</span><span class="w">     </span><span class="c1"># Event handler (ProfileEstablished → Profile aggregate)</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">established_to_directory</span><span class="o">.</span><span class="n">ex</span><span class="w"> </span><span class="c1"># Projection (ProfileEstablished → ProfileDirectory)</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">when_account_activated_then_establish_profile</span><span class="o">.</span><span class="n">ex</span><span class="w">  </span><span class="c1"># Policy</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">update_profile</span><span class="o">/</span><span class="w">                 </span><span class="c1"># Another command slice</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">command</span><span class="o">.</span><span class="n">ex</span><span class="w">                   </span><span class="c1"># UpdateProfile command</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">ex</span><span class="w">                     </span><span class="c1"># ProfileUpdated event</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">handler</span><span class="o">.</span><span class="n">ex</span><span class="w">                   </span><span class="c1"># Command handler</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">updated_to_state</span><span class="o">.</span><span class="n">ex</span><span class="w">         </span><span class="c1"># Event handler</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">updated_to_directory</span><span class="o">.</span><span class="n">ex</span><span class="w">     </span><span class="c1"># Projection</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">deactivate_profile</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">command</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">handler</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">       </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">deactivated_to_state</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">projections</span><span class="o">/</span><span class="w">                        </span><span class="c1"># Cross-cutting projections (if needed)</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">       </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">profile_search_projection</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">reckon_profiles</span><span class="o">.</span><span class="n">ex</span><span class="w">                      </span><span class="c1"># Public API</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">...</span></code></pre><h3 id="example-file-names-and-module-names" class="section-heading"><a href="#example-file-names-and-module-names" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Example: File Names and Module Names</span></h3><p><strong>Command:</strong></p><ul><li>File: <code class="inline">lib/reckon_profiles/domain/establish_profile/command.ex</code></li><li>Module: <code class="inline">ReckonProfiles.Domain.EstablishProfile.Command</code></li></ul><p><strong>Event:</strong></p><ul><li>File: <code class="inline">lib/reckon_profiles/domain/establish_profile/event.ex</code></li><li>Module: <code class="inline">ReckonProfiles.Domain.EstablishProfile.Event</code></li></ul><p><strong>Command Handler:</strong></p><ul><li>File: <code class="inline">lib/reckon_profiles/domain/establish_profile/handler.ex</code></li><li>Module: <code class="inline">ReckonProfiles.Domain.EstablishProfile.Handler</code></li></ul><p><strong>Event Handler (to State):</strong></p><ul><li>File: <code class="inline">lib/reckon_profiles/domain/establish_profile/established_to_state.ex</code></li><li>Module: <code class="inline">ReckonProfiles.Domain.EstablishProfile.EstablishedToState</code></li></ul><p><strong>Projection:</strong></p><ul><li>File: <code class="inline">lib/reckon_profiles/domain/establish_profile/established_to_directory.ex</code></li><li>Module: <code class="inline">ReckonProfiles.Domain.EstablishProfile.EstablishedToDirectory</code></li></ul><p><strong>Policy:</strong></p><ul><li>File: <code class="inline">lib/reckon_profiles/domain/establish_profile/when_account_activated_then_establish_profile.ex</code></li><li>Module: <code class="inline">ReckonProfiles.Domain.EstablishProfile.WhenAccountActivatedThenEstablishProfile</code></li></ul><h3 id="key-naming-rules-summary" class="section-heading"><a href="#key-naming-rules-summary" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Key Naming Rules Summary</span></h3><ol><li><strong>Directory Structure</strong>: <code class="inline">reckon_[domain]/lib/reckon_[domain]/domain/[command_name]/</code></li><li><strong>Slice Names</strong>: Named after the <strong>command</strong> (not the business operation)</li><li><strong>Handler Types</strong>:<ul><li><code class="inline">maybe_[command].ex</code> = Command Handler</li><li><code class="inline">[event]_to_state.ex</code> = Event Handler (aggregate updates)</li></ul></li><li><strong>Projections</strong>: <code class="inline">[event]_to_[readmodel].ex</code> (in slice with event)</li><li><strong>Policies</strong>: <code class="inline">when_[event]_then_[command].ex</code> (in slice with command they trigger)</li><li><strong>Module Naming</strong>: <code class="inline">ReckonDomain.Domain.CommandName.FileType</code></li></ol><h3 id="6-screaming-business-intent" class="section-heading"><a href="#6-screaming-business-intent" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">6. Screaming Business Intent</span></h3><p>Folder names should express <strong>business operations</strong>, not technical concepts:</p><p><strong>✅ GOOD - Business-focused names:</strong></p><ul><li><code class="inline">initialize_account/</code></li><li><code class="inline">verify_email/</code></li><li><code class="inline">create_profile/</code></li><li><code class="inline">update_profile_picture/</code></li><li><code class="inline">close_account/</code></li></ul><p><strong>❌ BAD - Technical-focused names:</strong></p><ul><li><code class="inline">commands/</code></li><li><code class="inline">events/</code></li><li><code class="inline">handlers/</code></li><li><code class="inline">controllers/</code></li><li><code class="inline">services/</code></li></ul><h2 id="module-naming-conventions" class="section-heading"><a href="#module-naming-conventions" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Module Naming Conventions</span></h2><h3 id="command-modules" class="section-heading"><a href="#command-modules" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Command Modules</span></h3><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ReckonProfiles.CreateProfile.Command</span><span class="w"> </span><span class="k" data-group-id="3854005511-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Command to create a new user profile.
  
  This command is triggered when a user completes their initial
  profile setup after account verification.
  &quot;&quot;&quot;</span><span class="w">
  
  </span><span class="kd">defstruct</span><span class="w"> </span><span class="p" data-group-id="3854005511-2">[</span><span class="w">
    </span><span class="ss">:account_id</span><span class="p">,</span><span class="w">
    </span><span class="ss">:display_name</span><span class="p">,</span><span class="w">
    </span><span class="ss">:bio</span><span class="p">,</span><span class="w">
    </span><span class="ss">:requested_at</span><span class="w">
  </span><span class="p" data-group-id="3854005511-2">]</span><span class="w">
  
  </span><span class="na">@type</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p">%</span><span class="bp">__MODULE__</span><span class="p" data-group-id="3854005511-3">{</span><span class="w">
    </span><span class="ss">account_id</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="3854005511-4">(</span><span class="p" data-group-id="3854005511-4">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">display_name</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="3854005511-5">(</span><span class="p" data-group-id="3854005511-5">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">bio</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="3854005511-6">(</span><span class="p" data-group-id="3854005511-6">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w">
    </span><span class="ss">requested_at</span><span class="p">:</span><span class="w"> </span><span class="nc">DateTime</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="3854005511-7">(</span><span class="p" data-group-id="3854005511-7">)</span><span class="w">
  </span><span class="p" data-group-id="3854005511-3">}</span><span class="w">
</span><span class="k" data-group-id="3854005511-1">end</span></code></pre><h3 id="event-modules" class="section-heading"><a href="#event-modules" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Event Modules</span></h3><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ReckonProfiles.CreateProfile.Event</span><span class="w"> </span><span class="k" data-group-id="0221267875-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Event emitted when a profile is successfully created.
  
  This event triggers read model updates and may trigger
  other domain reactions.
  &quot;&quot;&quot;</span><span class="w">
  
  </span><span class="na">@derive</span><span class="w"> </span><span class="nc">Jason.Encoder</span><span class="w">
  </span><span class="kd">defstruct</span><span class="w"> </span><span class="p" data-group-id="0221267875-2">[</span><span class="w">
    </span><span class="ss">:account_id</span><span class="p">,</span><span class="w">
    </span><span class="ss">:display_name</span><span class="p">,</span><span class="w">
    </span><span class="ss">:bio</span><span class="p">,</span><span class="w">
    </span><span class="ss">:created_at</span><span class="p">,</span><span class="w">
    </span><span class="ss">:version</span><span class="w">
  </span><span class="p" data-group-id="0221267875-2">]</span><span class="w">
  
  </span><span class="na">@type</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p">%</span><span class="bp">__MODULE__</span><span class="p" data-group-id="0221267875-3">{</span><span class="w">
    </span><span class="ss">account_id</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="0221267875-4">(</span><span class="p" data-group-id="0221267875-4">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">display_name</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="0221267875-5">(</span><span class="p" data-group-id="0221267875-5">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">bio</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="0221267875-6">(</span><span class="p" data-group-id="0221267875-6">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">nil</span><span class="p">,</span><span class="w">
    </span><span class="ss">created_at</span><span class="p">:</span><span class="w"> </span><span class="nc">DateTime</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="0221267875-7">(</span><span class="p" data-group-id="0221267875-7">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">version</span><span class="p">:</span><span class="w"> </span><span class="n">integer</span><span class="p" data-group-id="0221267875-8">(</span><span class="p" data-group-id="0221267875-8">)</span><span class="w">
  </span><span class="p" data-group-id="0221267875-3">}</span><span class="w">
</span><span class="k" data-group-id="0221267875-1">end</span></code></pre><h3 id="handler-modules" class="section-heading"><a href="#handler-modules" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Handler Modules</span></h3><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ReckonProfiles.CreateProfile.Handler</span><span class="w"> </span><span class="k" data-group-id="9388928500-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Command handler for CreateProfile command.
  
  Business rules:
  - Profile can only be created once per account
  - Display name must be unique
  - Bio is optional but limited to 500 characters
  &quot;&quot;&quot;</span><span class="w">
  
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">ReckonProfiles.Shared.Profile</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">ReckonProfiles.CreateProfile</span><span class="o">.</span><span class="p" data-group-id="9388928500-2">{</span><span class="nc">Command</span><span class="p">,</span><span class="w"> </span><span class="nc">Event</span><span class="p" data-group-id="9388928500-2">}</span><span class="w">
  
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">execute</span><span class="p" data-group-id="9388928500-3">(</span><span class="p" data-group-id="9388928500-4">%</span><span class="nc" data-group-id="9388928500-4">Profile</span><span class="p" data-group-id="9388928500-4">{</span><span class="ss">account_id</span><span class="p">:</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="9388928500-4">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9388928500-5">%</span><span class="nc" data-group-id="9388928500-5">Command</span><span class="p" data-group-id="9388928500-5">{</span><span class="p" data-group-id="9388928500-5">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">command</span><span class="p" data-group-id="9388928500-3">)</span><span class="w"> </span><span class="k" data-group-id="9388928500-6">do</span><span class="w">
    </span><span class="c1"># Business logic here</span><span class="w">
    </span><span class="p" data-group-id="9388928500-7">%</span><span class="nc" data-group-id="9388928500-7">Event</span><span class="p" data-group-id="9388928500-7">{</span><span class="w">
      </span><span class="ss">account_id</span><span class="p">:</span><span class="w"> </span><span class="n">command</span><span class="o">.</span><span class="n">account_id</span><span class="p">,</span><span class="w">
      </span><span class="ss">display_name</span><span class="p">:</span><span class="w"> </span><span class="n">command</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span><span class="w">
      </span><span class="ss">bio</span><span class="p">:</span><span class="w"> </span><span class="n">command</span><span class="o">.</span><span class="n">bio</span><span class="p">,</span><span class="w">
      </span><span class="ss">created_at</span><span class="p">:</span><span class="w"> </span><span class="n">command</span><span class="o">.</span><span class="n">requested_at</span><span class="p">,</span><span class="w">
      </span><span class="ss">version</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="p" data-group-id="9388928500-7">}</span><span class="w">
  </span><span class="k" data-group-id="9388928500-6">end</span><span class="w">
  
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">execute</span><span class="p" data-group-id="9388928500-8">(</span><span class="p" data-group-id="9388928500-9">%</span><span class="nc" data-group-id="9388928500-9">Profile</span><span class="p" data-group-id="9388928500-9">{</span><span class="p" data-group-id="9388928500-9">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9388928500-10">%</span><span class="nc" data-group-id="9388928500-10">Command</span><span class="p" data-group-id="9388928500-10">{</span><span class="p" data-group-id="9388928500-10">}</span><span class="p" data-group-id="9388928500-8">)</span><span class="w"> </span><span class="k" data-group-id="9388928500-11">do</span><span class="w">
    </span><span class="p" data-group-id="9388928500-12">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="ss">:profile_already_exists</span><span class="p" data-group-id="9388928500-12">}</span><span class="w">
  </span><span class="k" data-group-id="9388928500-11">end</span><span class="w">
  
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">apply</span><span class="p" data-group-id="9388928500-13">(</span><span class="p" data-group-id="9388928500-14">%</span><span class="nc" data-group-id="9388928500-14">Profile</span><span class="p" data-group-id="9388928500-14">{</span><span class="p" data-group-id="9388928500-14">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">profile</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9388928500-15">%</span><span class="nc" data-group-id="9388928500-15">Event</span><span class="p" data-group-id="9388928500-15">{</span><span class="p" data-group-id="9388928500-15">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="p" data-group-id="9388928500-13">)</span><span class="w"> </span><span class="k" data-group-id="9388928500-16">do</span><span class="w">
    </span><span class="c1"># State updates here</span><span class="w">
    </span><span class="p" data-group-id="9388928500-17">%</span><span class="nc" data-group-id="9388928500-17">Profile</span><span class="p" data-group-id="9388928500-17">{</span><span class="n">profile</span><span class="w"> </span><span class="o">|</span><span class="w">
      </span><span class="ss">account_id</span><span class="p">:</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">account_id</span><span class="p">,</span><span class="w">
      </span><span class="ss">display_name</span><span class="p">:</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span><span class="w">
      </span><span class="ss">bio</span><span class="p">:</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">bio</span><span class="p">,</span><span class="w">
      </span><span class="ss">created_at</span><span class="p">:</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span><span class="w">
      </span><span class="ss">updated_at</span><span class="p">:</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">created_at</span><span class="w">
    </span><span class="p" data-group-id="9388928500-17">}</span><span class="w">
  </span><span class="k" data-group-id="9388928500-16">end</span><span class="w">
</span><span class="k" data-group-id="9388928500-1">end</span></code></pre><h2 id="technical-configuration" class="section-heading"><a href="#technical-configuration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Technical Configuration</span></h2><h3 id="dependencies-mix-exs" class="section-heading"><a href="#dependencies-mix-exs" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Dependencies (mix.exs)</span></h3><pre><code class="makeup elixir" translate="no"><span class="kd">defp</span><span class="w"> </span><span class="nf">deps</span><span class="w"> </span><span class="k" data-group-id="9749436608-1">do</span><span class="w">
  </span><span class="p" data-group-id="9749436608-2">[</span><span class="w">
    </span><span class="p" data-group-id="9749436608-3">{</span><span class="ss">:dns_cluster</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.1.1&quot;</span><span class="p" data-group-id="9749436608-3">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="9749436608-4">{</span><span class="ss">:phoenix_pubsub</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 2.1&quot;</span><span class="p" data-group-id="9749436608-4">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="9749436608-5">{</span><span class="ss">:ecto_sql</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 3.10&quot;</span><span class="p" data-group-id="9749436608-5">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="9749436608-6">{</span><span class="ss">:ecto_sqlite3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&gt;= 0.0.0&quot;</span><span class="p" data-group-id="9749436608-6">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="9749436608-7">{</span><span class="ss">:jason</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 1.2&quot;</span><span class="p" data-group-id="9749436608-7">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="9749436608-8">{</span><span class="ss">:ex_esdb</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.1.4&quot;</span><span class="p" data-group-id="9749436608-8">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="9749436608-9">{</span><span class="ss">:ex_esdb_commanded</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;0.1.3&quot;</span><span class="p" data-group-id="9749436608-9">}</span><span class="w">
  </span><span class="p" data-group-id="9749436608-2">]</span><span class="w">
</span><span class="k" data-group-id="9749436608-1">end</span></code></pre><h3 id="exesdb-configuration-config-config-exs" class="section-heading"><a href="#exesdb-configuration-config-config-exs" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">ExESDB Configuration (config/config.exs)</span></h3><pre><code class="makeup elixir" translate="no"><span class="c1"># Configure ExESDB for ReckonProfiles</span><span class="w">
</span><span class="n">config</span><span class="w"> </span><span class="ss">:ex_esdb</span><span class="p">,</span><span class="w"> </span><span class="ss">:khepri</span><span class="p">,</span><span class="w">
  </span><span class="ss">data_dir</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;tmp/reckon_profiles&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">store_id</span><span class="p">:</span><span class="w"> </span><span class="ss">:reckon_profiles</span><span class="p">,</span><span class="w">  </span><span class="c1"># 🔥 UNIQUE per domain</span><span class="w">
  </span><span class="ss">timeout</span><span class="p">:</span><span class="w"> </span><span class="mi">10_000</span><span class="p">,</span><span class="w">
  </span><span class="ss">db_type</span><span class="p">:</span><span class="w"> </span><span class="ss">:single</span><span class="p">,</span><span class="w">
  </span><span class="ss">pub_sub</span><span class="p">:</span><span class="w"> </span><span class="ss">:ex_esdb_pubsub</span><span class="p">,</span><span class="w">
  </span><span class="ss">store_description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Reckon Profiles Event Store&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">store_tags</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9852552414-1">[</span><span class="s">&quot;reckon&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;profiles&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;event-sourcing&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;development&quot;</span><span class="p" data-group-id="9852552414-1">]</span><span class="w">

</span><span class="c1"># Configure the Commanded application</span><span class="w">
</span><span class="n">config</span><span class="w"> </span><span class="ss">:reckon_profiles</span><span class="p">,</span><span class="w"> </span><span class="nc">ReckonProfiles.CommandedApp</span><span class="p">,</span><span class="w">
  </span><span class="ss">event_store</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9852552414-2">[</span><span class="w">
    </span><span class="ss">adapter</span><span class="p">:</span><span class="w"> </span><span class="nc">ExESDB.Commanded.Adapter</span><span class="p">,</span><span class="w">
    </span><span class="ss">store_id</span><span class="p">:</span><span class="w"> </span><span class="ss">:reckon_profiles</span><span class="p">,</span><span class="w">
    </span><span class="ss">stream_prefix</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;reckon_profiles_&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># 🔥 UNIQUE per domain</span><span class="w">
    </span><span class="ss">serializer</span><span class="p">:</span><span class="w"> </span><span class="nc">Jason</span><span class="p">,</span><span class="w">
    </span><span class="ss">event_type_mapper</span><span class="p">:</span><span class="w"> </span><span class="nc">ReckonProfiles.EventTypeMapper</span><span class="w">
  </span><span class="p" data-group-id="9852552414-2">]</span></code></pre><h3 id="libcluster-configuration-user-preference" class="section-heading"><a href="#libcluster-configuration-user-preference" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">LibCluster Configuration (User Preference)</span></h3><pre><code class="makeup elixir" translate="no"><span class="c1"># Configure libcluster (preferred over seed_nodes)</span><span class="w">
</span><span class="n">config</span><span class="w"> </span><span class="ss">:libcluster</span><span class="p">,</span><span class="w">
  </span><span class="ss">topologies</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8206189049-1">[</span><span class="w">
    </span><span class="ss">reckon_profiles</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8206189049-2">[</span><span class="w">
      </span><span class="ss">strategy</span><span class="p">:</span><span class="w"> </span><span class="nc">Cluster.Strategy.Gossip</span><span class="p">,</span><span class="w">
      </span><span class="ss">config</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8206189049-3">[</span><span class="w">
        </span><span class="ss">port</span><span class="p">:</span><span class="w"> </span><span class="mi">45_894</span><span class="p">,</span><span class="w">  </span><span class="c1"># 🔥 UNIQUE per domain</span><span class="w">
        </span><span class="ss">if_addr</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0.0.0.0&quot;</span><span class="p">,</span><span class="w">
        </span><span class="ss">multicast_addr</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;255.255.255.255&quot;</span><span class="p">,</span><span class="w">
        </span><span class="ss">broadcast_only</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w">
        </span><span class="ss">secret</span><span class="p">:</span><span class="w"> </span><span class="nc">System</span><span class="o">.</span><span class="n">get_env</span><span class="p" data-group-id="8206189049-4">(</span><span class="s">&quot;RECKON_PROFILES_CLUSTER_SECRET&quot;</span><span class="p" data-group-id="8206189049-4">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s">&quot;reckon_profiles_cluster_secret&quot;</span><span class="w">
      </span><span class="p" data-group-id="8206189049-3">]</span><span class="w">
    </span><span class="p" data-group-id="8206189049-2">]</span><span class="w">
  </span><span class="p" data-group-id="8206189049-1">]</span></code></pre><h2 id="public-api-pattern" class="section-heading"><a href="#public-api-pattern" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Public API Pattern</span></h2><p>The main module provides a business-focused API:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ReckonProfiles</span><span class="w"> </span><span class="k" data-group-id="3558198940-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  ReckonProfiles domain - User profile management and personalization.
  
  This module provides the public API for profile operations including:
  - Profile creation and updates
  - Profile picture management
  - Privacy settings
  
  Uses vertical slicing architecture where each command has its own slice
  containing command, events, and handlers.
  &quot;&quot;&quot;</span><span class="w">
  
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">ReckonProfiles.CommandedApp</span><span class="w">
  
  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Creates a new user profile.
  
  This is typically called after account verification is complete.
  &quot;&quot;&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">create_profile</span><span class="p" data-group-id="3558198940-2">(</span><span class="n">account_id</span><span class="p">,</span><span class="w"> </span><span class="n">display_name</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="3558198940-2">)</span><span class="w"> </span><span class="k" data-group-id="3558198940-3">do</span><span class="w">
    </span><span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="3558198940-4">%</span><span class="nc" data-group-id="3558198940-4">ReckonProfiles.CreateProfile.Command</span><span class="p" data-group-id="3558198940-4">{</span><span class="w">
      </span><span class="ss">account_id</span><span class="p">:</span><span class="w"> </span><span class="n">account_id</span><span class="p">,</span><span class="w">
      </span><span class="ss">display_name</span><span class="p">:</span><span class="w"> </span><span class="n">display_name</span><span class="p">,</span><span class="w">
      </span><span class="ss">bio</span><span class="p">:</span><span class="w"> </span><span class="n">bio</span><span class="p">,</span><span class="w">
      </span><span class="ss">requested_at</span><span class="p">:</span><span class="w"> </span><span class="nc">DateTime</span><span class="o">.</span><span class="n">utc_now</span><span class="p" data-group-id="3558198940-5">(</span><span class="p" data-group-id="3558198940-5">)</span><span class="w">
    </span><span class="p" data-group-id="3558198940-4">}</span><span class="w">
    
    </span><span class="nc">CommandedApp</span><span class="o">.</span><span class="n">dispatch</span><span class="p" data-group-id="3558198940-6">(</span><span class="n">command</span><span class="p" data-group-id="3558198940-6">)</span><span class="w">
  </span><span class="k" data-group-id="3558198940-3">end</span><span class="w">
  
  </span><span class="c1"># ... other business operations</span><span class="w">
</span><span class="k" data-group-id="3558198940-1">end</span></code></pre><h2 id="key-benefits-of-this-architecture" class="section-heading"><a href="#key-benefits-of-this-architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Key Benefits of This Architecture</span></h2><ol><li><strong>Discoverability</strong>: New developers can immediately understand what the system does by looking at folder names</li><li><strong>Maintainability</strong>: Changes to one business operation don't affect others</li><li><strong>Testability</strong>: Each slice can be unit tested independently</li><li><strong>Scalability</strong>: Teams can work on different slices without conflicts</li><li><strong>Business Alignment</strong>: Code structure mirrors business processes</li></ol><h2 id="projection-naming-and-organization" class="section-heading"><a href="#projection-naming-and-organization" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Projection Naming and Organization</span></h2><h3 id="event-to-projection-naming-pattern" class="section-heading"><a href="#event-to-projection-naming-pattern" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Event-to-Projection Naming Pattern</span></h3><p>Projections should use the <code class="inline">event_to_projection_type</code> naming pattern to immediately communicate their intent and relationship, following screaming architecture principles:</p><pre><code class="makeup elixir" translate="no"><span class="n">reckon_</span><span class="p" data-group-id="1214149297-1">[</span><span class="n">domain</span><span class="p" data-group-id="1214149297-1">]</span><span class="o">/</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">lib</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">reckon_</span><span class="p" data-group-id="1214149297-2">[</span><span class="n">domain</span><span class="p" data-group-id="1214149297-2">]</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">initialize_account</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">command</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">handler</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">initialized_to_summary</span><span class="o">.</span><span class="n">ex</span><span class="w">    </span><span class="c1"># Projection: AccountInitialized → AccountSummary</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">activate_account</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">command</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">handler</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">activated_to_summary</span><span class="o">.</span><span class="n">ex</span><span class="w">      </span><span class="c1"># Projection: AccountActivated → AccountSummary</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">close_account</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">command</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">handler</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">       </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">closed_to_summary</span><span class="o">.</span><span class="n">ex</span><span class="w">         </span><span class="c1"># Projection: AccountClosed → AccountSummary</span></code></pre><h3 id="projection-module-naming" class="section-heading"><a href="#projection-module-naming" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Projection Module Naming</span></h3><p>Projection modules should follow the same naming pattern:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># lib/reckon_accounts/initialize_account/initialized_to_summary.ex</span><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ReckonAccounts.InitializeAccount.InitializedToSummary</span><span class="w"> </span><span class="k" data-group-id="2294235345-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Projection that handles AccountInitialized events and updates the AccountSummary read model.
  
  This projection creates new entries in the account_summaries table when accounts are initialized.
  &quot;&quot;&quot;</span><span class="w">
  
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Commanded.Projections.Ecto</span><span class="p">,</span><span class="w">
    </span><span class="ss">application</span><span class="p">:</span><span class="w"> </span><span class="nc">ReckonAccounts.CommandedApp</span><span class="p">,</span><span class="w">
    </span><span class="ss">repo</span><span class="p">:</span><span class="w"> </span><span class="nc">ReckonAccounts.Repo</span><span class="p">,</span><span class="w">
    </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ReckonAccounts.InitializeAccount.InitializedToSummary&quot;</span><span class="w">
  
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">ReckonAccounts.InitializeAccount.Event</span><span class="p">,</span><span class="w"> </span><span class="ss">as</span><span class="p">:</span><span class="w"> </span><span class="nc">AccountInitialized</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">ReckonAccounts.Schemas.AccountSummary</span><span class="w">
  
  </span><span class="n">project</span><span class="p" data-group-id="2294235345-2">(</span><span class="p" data-group-id="2294235345-3">%</span><span class="nc" data-group-id="2294235345-3">AccountInitialized</span><span class="p" data-group-id="2294235345-3">{</span><span class="p" data-group-id="2294235345-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="c">_metadata</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="2294235345-4">fn</span><span class="w"> </span><span class="n">multi</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="c1"># Projection logic here</span><span class="w">
  </span><span class="k" data-group-id="2294235345-4">end</span><span class="p" data-group-id="2294235345-2">)</span><span class="w">
</span><span class="k" data-group-id="2294235345-1">end</span></code></pre><h2 id="testing-guidelines" class="section-heading"><a href="#testing-guidelines" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Testing Guidelines</span></h2><h3 id="vertical-slicing-in-tests" class="section-heading"><a href="#vertical-slicing-in-tests" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Vertical Slicing in Tests</span></h3><p>Tests should mirror the vertical slicing architecture and include projections within their related slices:</p><pre><code class="makeup elixir" translate="no"><span class="n">reckon_</span><span class="p" data-group-id="2406399394-1">[</span><span class="n">domain</span><span class="p" data-group-id="2406399394-1">]</span><span class="o">/</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">test</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">reckon_</span><span class="p" data-group-id="2406399394-2">[</span><span class="n">domain</span><span class="p" data-group-id="2406399394-2">]</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">initialize_account</span><span class="o">/</span><span class="w">              </span><span class="c1"># Tests for initialize_account slice</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">command_test</span><span class="o">.</span><span class="n">exs</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">handler_test</span><span class="o">.</span><span class="n">exs</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">event_test</span><span class="o">.</span><span class="n">exs</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">initialized_to_summary_test</span><span class="o">.</span><span class="n">exs</span><span class="w">  </span><span class="c1"># Projection test within slice</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">activate_account</span><span class="o">/</span><span class="w">                </span><span class="c1"># Tests for activate_account slice</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">command_test</span><span class="o">.</span><span class="n">exs</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">handler_test</span><span class="o">.</span><span class="n">exs</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">event_test</span><span class="o">.</span><span class="n">exs</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">activated_to_summary_test</span><span class="o">.</span><span class="n">exs</span><span class="w">    </span><span class="c1"># Projection test within slice</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">close_account</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">command_test</span><span class="o">.</span><span class="n">exs</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">handler_test</span><span class="o">.</span><span class="n">exs</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">event_test</span><span class="o">.</span><span class="n">exs</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">       </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">closed_to_summary_test</span><span class="o">.</span><span class="n">exs</span><span class="w">       </span><span class="c1"># Projection test within slice</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">support</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">test_helper</span><span class="o">.</span><span class="n">ex</span></code></pre><h3 id="test-isolation-principles" class="section-heading"><a href="#test-isolation-principles" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Test Isolation Principles</span></h3><ol><li><p><strong>Domain Tests Should Be Isolated</strong>: Each domain's tests should run independently without requiring other domains to be running.</p></li><li><p><strong>Use Ecto.Adapters.SQL.Sandbox</strong>: For database tests, use sandbox mode to ensure test isolation:</p></li></ol><pre><code class="makeup elixir" translate="no"><span class="c1"># test/test_helper.exs</span><span class="w">
</span><span class="nc">Ecto.Adapters.SQL.Sandbox</span><span class="o">.</span><span class="n">mode</span><span class="p" data-group-id="0434152960-1">(</span><span class="nc">ReckonAccounts.Repo</span><span class="p">,</span><span class="w"> </span><span class="ss">:manual</span><span class="p" data-group-id="0434152960-1">)</span><span class="w">

</span><span class="c1"># In test modules</span><span class="w">
</span><span class="n">setup</span><span class="w"> </span><span class="k" data-group-id="0434152960-2">do</span><span class="w">
  </span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ecto.Adapters.SQL.Sandbox</span><span class="o">.</span><span class="n">checkout</span><span class="p" data-group-id="0434152960-3">(</span><span class="nc">ReckonAccounts.Repo</span><span class="p" data-group-id="0434152960-3">)</span><span class="w">
</span><span class="k" data-group-id="0434152960-2">end</span></code></pre><ol start="3"><li><p><strong>Test Each Slice Independently</strong>: Write unit tests for commands, handlers, events, and projections separately within each slice.</p></li><li><p><strong>Integration Tests for Cross-Slice Interactions</strong>: Use integration tests sparingly and only when testing interactions between slices within the same domain.</p></li></ol><h3 id="projection-testing-guidelines" class="section-heading"><a href="#projection-testing-guidelines" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Projection Testing Guidelines</span></h3><ol><li><p><strong>Projections Stay With Their Events</strong>: Projections should be located in the same slice as their related events, using the <code class="inline">event_to_projection_type</code> naming pattern.</p></li><li><p><strong>Test Projections Separately</strong>: Write dedicated tests for projections that verify:</p><ul><li>Event handling and state updates</li><li>Database persistence</li><li>Error handling and recovery</li></ul></li><li><p><strong>Use Test Fixtures</strong>: Create test fixtures for events to ensure consistent testing:</p></li></ol><pre><code class="makeup elixir" translate="no"><span class="c1"># test/support/fixtures.ex</span><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ReckonAccounts.Fixtures</span><span class="w"> </span><span class="k" data-group-id="7069155777-1">do</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">account_initialized_event</span><span class="p" data-group-id="7069155777-2">(</span><span class="n">attrs</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="7069155777-3">%{</span><span class="p" data-group-id="7069155777-3">}</span><span class="p" data-group-id="7069155777-2">)</span><span class="w"> </span><span class="k" data-group-id="7069155777-4">do</span><span class="w">
    </span><span class="p" data-group-id="7069155777-5">%</span><span class="nc" data-group-id="7069155777-5">ReckonAccounts.InitializeAccount.Event</span><span class="p" data-group-id="7069155777-5">{</span><span class="w">
      </span><span class="ss">account_id</span><span class="p">:</span><span class="w"> </span><span class="n">attrs</span><span class="p" data-group-id="7069155777-6">[</span><span class="ss">:account_id</span><span class="p" data-group-id="7069155777-6">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s">&quot;test-account-123&quot;</span><span class="p">,</span><span class="w">
      </span><span class="ss">email</span><span class="p">:</span><span class="w"> </span><span class="n">attrs</span><span class="p" data-group-id="7069155777-7">[</span><span class="ss">:email</span><span class="p" data-group-id="7069155777-7">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s">&quot;test@example.com&quot;</span><span class="p">,</span><span class="w">
      </span><span class="ss">initialized_at</span><span class="p">:</span><span class="w"> </span><span class="n">attrs</span><span class="p" data-group-id="7069155777-8">[</span><span class="ss">:initialized_at</span><span class="p" data-group-id="7069155777-8">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nc">DateTime</span><span class="o">.</span><span class="n">utc_now</span><span class="p" data-group-id="7069155777-9">(</span><span class="p" data-group-id="7069155777-9">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">DateTime</span><span class="o">.</span><span class="n">truncate</span><span class="p" data-group-id="7069155777-10">(</span><span class="ss">:second</span><span class="p" data-group-id="7069155777-10">)</span><span class="w">
    </span><span class="p" data-group-id="7069155777-5">}</span><span class="w">
  </span><span class="k" data-group-id="7069155777-4">end</span><span class="w">
</span><span class="k" data-group-id="7069155777-1">end</span></code></pre><h2 id="integration-between-domains" class="section-heading"><a href="#integration-between-domains" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Integration Between Domains</span></h2><h3 id="web-service-proxy-pattern" class="section-heading"><a href="#web-service-proxy-pattern" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Web Service Proxy Pattern</span></h3><p>Integrations between domain services (<code class="inline">reckon_*</code> apps) and the website (<code class="inline">landing_site_web</code>) must go through the umbrella's web service proxy (<code class="inline">landing_site</code>). This ensures:</p><ol><li><strong>Loose Coupling</strong>: Domains don't directly depend on web concerns</li><li><strong>Consistent API</strong>: All web interactions go through a single, well-defined interface</li><li><strong>Testability</strong>: Web and domain logic can be tested independently</li><li><strong>Scalability</strong>: Domains can be extracted to separate services later</li></ol><pre><code class="makeup elixir" translate="no"><span class="c1"># ✅ Correct: Web interactions through proxy</span><span class="w">
</span><span class="nc">LandingSite.Accounts</span><span class="o">.</span><span class="n">initialize_account</span><span class="p" data-group-id="2647639141-1">(</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p" data-group-id="2647639141-1">)</span><span class="w">

</span><span class="c1"># ❌ Incorrect: Direct domain access from web</span><span class="w">
</span><span class="nc">ReckonAccounts</span><span class="o">.</span><span class="n">initialize_account</span><span class="p" data-group-id="2647639141-2">(</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p" data-group-id="2647639141-2">)</span></code></pre><h2 id="integration-events-facts-pattern" class="section-heading"><a href="#integration-events-facts-pattern" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Integration Events (Facts) Pattern</span></h2><h3 id="facts-vs-domain-events" class="section-heading"><a href="#facts-vs-domain-events" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Facts vs Domain Events</span></h3><p><strong>Domain Events</strong> are internal to a domain and handle business logic within that domain.</p><p><strong>Facts</strong> are integration events that communicate between domains. They represent immutable facts about what happened in one domain that other domains might care about.</p><h3 id="facts-structure" class="section-heading"><a href="#facts-structure" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Facts Structure</span></h3><p>Facts are defined in the <code class="inline">reckon_shared</code> application, organized by originating domain:</p><pre><code class="makeup elixir" translate="no"><span class="n">reckon_shared</span><span class="o">/</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">lib</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">reckon_shared</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">accounts</span><span class="o">/</span><span class="w">                    </span><span class="c1"># Facts from reckon_accounts domain</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">account_initialized_fact</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">account_activated_fact</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">account_closed_fact</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">profiles</span><span class="o">/</span><span class="w">                    </span><span class="c1"># Facts from reckon_profiles domain</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">profile_created_fact</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">profile_updated_fact</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">memberships</span><span class="o">/</span><span class="w">                 </span><span class="c1"># Facts from reckon_memberships domain</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">membership_created_fact</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">       </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">membership_expired_fact</span><span class="o">.</span><span class="n">ex</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">reckon_shared</span><span class="o">.</span><span class="n">ex</span></code></pre><h3 id="fact-module-pattern" class="section-heading"><a href="#fact-module-pattern" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Fact Module Pattern</span></h3><pre><code class="makeup elixir" translate="no"><span class="c1"># lib/reckon_shared/accounts/account_activated_fact.ex</span><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ReckonShared.Accounts.AccountActivatedFact</span><span class="w"> </span><span class="k" data-group-id="7068517074-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Integration event (Fact) emitted when an account is activated.
  
  This fact is consumed by other domains that need to react to
  account activation, such as:
  - ReckonProfiles (to enable profile creation)
  - ReckonMemberships (to activate trial memberships)
  &quot;&quot;&quot;</span><span class="w">
  
  </span><span class="na">@derive</span><span class="w"> </span><span class="nc">Jason.Encoder</span><span class="w">
  </span><span class="kd">defstruct</span><span class="w"> </span><span class="p" data-group-id="7068517074-2">[</span><span class="w">
    </span><span class="ss">:account_id</span><span class="p">,</span><span class="w">
    </span><span class="ss">:email</span><span class="p">,</span><span class="w">
    </span><span class="ss">:activated_at</span><span class="p">,</span><span class="w">
    </span><span class="ss">:fact_id</span><span class="p">,</span><span class="w">
    </span><span class="ss">:fact_version</span><span class="w">
  </span><span class="p" data-group-id="7068517074-2">]</span><span class="w">
  
  </span><span class="na">@type</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p">%</span><span class="bp">__MODULE__</span><span class="p" data-group-id="7068517074-3">{</span><span class="w">
    </span><span class="ss">account_id</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="7068517074-4">(</span><span class="p" data-group-id="7068517074-4">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">email</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="7068517074-5">(</span><span class="p" data-group-id="7068517074-5">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">activated_at</span><span class="p">:</span><span class="w"> </span><span class="nc">DateTime</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="7068517074-6">(</span><span class="p" data-group-id="7068517074-6">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">fact_id</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="7068517074-7">(</span><span class="p" data-group-id="7068517074-7">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">fact_version</span><span class="p">:</span><span class="w"> </span><span class="n">integer</span><span class="p" data-group-id="7068517074-8">(</span><span class="p" data-group-id="7068517074-8">)</span><span class="w">
  </span><span class="p" data-group-id="7068517074-3">}</span><span class="w">
  
  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Creates a new account activated fact.
  &quot;&quot;&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">new</span><span class="p" data-group-id="7068517074-9">(</span><span class="n">account_id</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="n">activated_at</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="nc">DateTime</span><span class="o">.</span><span class="n">utc_now</span><span class="p" data-group-id="7068517074-10">(</span><span class="p" data-group-id="7068517074-10">)</span><span class="p" data-group-id="7068517074-9">)</span><span class="w"> </span><span class="k" data-group-id="7068517074-11">do</span><span class="w">
    </span><span class="p">%</span><span class="bp">__MODULE__</span><span class="p" data-group-id="7068517074-12">{</span><span class="w">
      </span><span class="ss">account_id</span><span class="p">:</span><span class="w"> </span><span class="n">account_id</span><span class="p">,</span><span class="w">
      </span><span class="ss">email</span><span class="p">:</span><span class="w"> </span><span class="n">email</span><span class="p">,</span><span class="w">
      </span><span class="ss">activated_at</span><span class="p">:</span><span class="w"> </span><span class="n">activated_at</span><span class="p">,</span><span class="w">
      </span><span class="ss">fact_id</span><span class="p">:</span><span class="w"> </span><span class="nc">UUID</span><span class="o">.</span><span class="n">uuid4</span><span class="p" data-group-id="7068517074-13">(</span><span class="p" data-group-id="7068517074-13">)</span><span class="p">,</span><span class="w">
      </span><span class="ss">fact_version</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="p" data-group-id="7068517074-12">}</span><span class="w">
  </span><span class="k" data-group-id="7068517074-11">end</span><span class="w">
</span><span class="k" data-group-id="7068517074-1">end</span></code></pre><h3 id="fact-projection-pattern" class="section-heading"><a href="#fact-projection-pattern" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Fact Projection Pattern</span></h3><p>Each domain has projections that convert domain events into facts and publish them:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># lib/reckon_accounts/projections/account_facts_projection.ex</span><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ReckonAccounts.Projections.AccountFactsProjection</span><span class="w"> </span><span class="k" data-group-id="9697535605-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Projection that converts domain events into integration facts.
  
  Publishes facts to PubSub topics for consumption by other domains.
  &quot;&quot;&quot;</span><span class="w">
  
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Commanded.Projections.Ecto</span><span class="p">,</span><span class="w">
    </span><span class="ss">application</span><span class="p">:</span><span class="w"> </span><span class="nc">ReckonAccounts.CommandedApp</span><span class="p">,</span><span class="w">
    </span><span class="ss">repo</span><span class="p">:</span><span class="w"> </span><span class="nc">ReckonAccounts.Repo</span><span class="p">,</span><span class="w">
    </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;account_facts_projection&quot;</span><span class="w">
  
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">ReckonAccounts.VerifyEmail.Event</span><span class="p">,</span><span class="w"> </span><span class="ss">as</span><span class="p">:</span><span class="w"> </span><span class="nc">EmailVerifiedEvent</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">ReckonShared.Accounts.AccountActivatedFact</span><span class="w">
  
  </span><span class="n">project</span><span class="p" data-group-id="9697535605-2">(</span><span class="p" data-group-id="9697535605-3">%</span><span class="nc" data-group-id="9697535605-3">EmailVerifiedEvent</span><span class="p" data-group-id="9697535605-3">{</span><span class="p" data-group-id="9697535605-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="c">_metadata</span><span class="p" data-group-id="9697535605-2">)</span><span class="w"> </span><span class="k" data-group-id="9697535605-4">do</span><span class="w">
    </span><span class="c1"># Convert domain event to integration fact</span><span class="w">
    </span><span class="n">fact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">AccountActivatedFact</span><span class="o">.</span><span class="n">new</span><span class="p" data-group-id="9697535605-5">(</span><span class="w">
      </span><span class="n">event</span><span class="o">.</span><span class="n">account_id</span><span class="p">,</span><span class="w">
      </span><span class="n">event</span><span class="o">.</span><span class="n">email</span><span class="p">,</span><span class="w">
      </span><span class="n">event</span><span class="o">.</span><span class="n">verified_at</span><span class="w">
    </span><span class="p" data-group-id="9697535605-5">)</span><span class="w">
    
    </span><span class="c1"># Publish to event-specific topic</span><span class="w">
    </span><span class="nc">Phoenix.PubSub</span><span class="o">.</span><span class="n">publish</span><span class="p" data-group-id="9697535605-6">(</span><span class="w">
      </span><span class="ss">:ex_esdb_pubsub</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;accounts:facts:account_activated&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">fact</span><span class="w">
    </span><span class="p" data-group-id="9697535605-6">)</span><span class="w">
    
    </span><span class="ss">:ok</span><span class="w">
  </span><span class="k" data-group-id="9697535605-4">end</span><span class="w">
</span><span class="k" data-group-id="9697535605-1">end</span></code></pre><h3 id="event-specific-topics-communication" class="section-heading"><a href="#event-specific-topics-communication" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Event-Specific Topics Communication</span></h3><p><strong>Design Rule</strong>: We communicate via event-specific topics, not generic domain topics.</p><p><strong>✅ GOOD - Event-specific topics:</strong></p><ul><li><code class="inline">&quot;accounts:facts:account_activated&quot;</code></li><li><code class="inline">&quot;accounts:facts:account_closed&quot;</code></li><li><code class="inline">&quot;profiles:facts:profile_created&quot;</code></li><li><code class="inline">&quot;profiles:facts:profile_updated&quot;</code></li><li><code class="inline">&quot;memberships:facts:membership_created&quot;</code></li></ul><p><strong>❌ BAD - Generic domain topics:</strong></p><ul><li><code class="inline">&quot;accounts:events&quot;</code></li><li><code class="inline">&quot;profiles:all&quot;</code></li><li><code class="inline">&quot;domain:updates&quot;</code></li></ul><h3 id="cross-domain-event-handling" class="section-heading"><a href="#cross-domain-event-handling" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Cross-Domain Event Handling</span></h3><p>Other domains subscribe to specific fact topics:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># lib/reckon_profiles/event_handlers/account_event_handler.ex</span><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ReckonProfiles.EventHandlers.AccountEventHandler</span><span class="w"> </span><span class="k" data-group-id="3370718449-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Handles account-related facts from other domains.
  &quot;&quot;&quot;</span><span class="w">
  
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">GenServer</span><span class="w">
  
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">ReckonShared.Accounts.AccountActivatedFact</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">ReckonProfiles.CreateProfile.Command</span><span class="w">
  
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">start_link</span><span class="p" data-group-id="3370718449-2">(</span><span class="n">opts</span><span class="p" data-group-id="3370718449-2">)</span><span class="w"> </span><span class="k" data-group-id="3370718449-3">do</span><span class="w">
    </span><span class="nc">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p" data-group-id="3370718449-4">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="bp">__MODULE__</span><span class="p" data-group-id="3370718449-4">)</span><span class="w">
  </span><span class="k" data-group-id="3370718449-3">end</span><span class="w">
  
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">init</span><span class="p" data-group-id="3370718449-5">(</span><span class="c">_opts</span><span class="p" data-group-id="3370718449-5">)</span><span class="w"> </span><span class="k" data-group-id="3370718449-6">do</span><span class="w">
    </span><span class="c1"># Subscribe to specific account facts</span><span class="w">
    </span><span class="nc">Phoenix.PubSub</span><span class="o">.</span><span class="n">subscribe</span><span class="p" data-group-id="3370718449-7">(</span><span class="ss">:ex_esdb_pubsub</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;accounts:facts:account_activated&quot;</span><span class="p" data-group-id="3370718449-7">)</span><span class="w">
    </span><span class="nc">Phoenix.PubSub</span><span class="o">.</span><span class="n">subscribe</span><span class="p" data-group-id="3370718449-8">(</span><span class="ss">:ex_esdb_pubsub</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;accounts:facts:account_closed&quot;</span><span class="p" data-group-id="3370718449-8">)</span><span class="w">
    
    </span><span class="p" data-group-id="3370718449-9">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3370718449-10">%{</span><span class="p" data-group-id="3370718449-10">}</span><span class="p" data-group-id="3370718449-9">}</span><span class="w">
  </span><span class="k" data-group-id="3370718449-6">end</span><span class="w">
  
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="3370718449-11">(</span><span class="p" data-group-id="3370718449-12">%</span><span class="nc" data-group-id="3370718449-12">AccountActivatedFact</span><span class="p" data-group-id="3370718449-12">{</span><span class="p" data-group-id="3370718449-12">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fact</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="3370718449-11">)</span><span class="w"> </span><span class="k" data-group-id="3370718449-13">do</span><span class="w">
    </span><span class="c1"># React to account activation by enabling profile creation</span><span class="w">
    </span><span class="c1"># (Business logic here)</span><span class="w">
    </span><span class="p" data-group-id="3370718449-14">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="3370718449-14">}</span><span class="w">
  </span><span class="k" data-group-id="3370718449-13">end</span><span class="w">
</span><span class="k" data-group-id="3370718449-1">end</span></code></pre><h3 id="topic-naming-convention" class="section-heading"><a href="#topic-naming-convention" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Topic Naming Convention</span></h3><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="0556507196-1">[</span><span class="n">source_domain</span><span class="p" data-group-id="0556507196-1">]</span><span class="ss">:facts</span><span class="p">:</span><span class="p" data-group-id="0556507196-2">[</span><span class="n">event_name</span><span class="p" data-group-id="0556507196-2">]</span></code></pre><p><strong>Examples:</strong></p><ul><li><code class="inline">accounts:facts:account_initialized</code></li><li><code class="inline">accounts:facts:account_activated</code></li><li><code class="inline">accounts:facts:account_closed</code></li><li><code class="inline">profiles:facts:profile_created</code></li><li><code class="inline">profiles:facts:profile_picture_updated</code></li><li><code class="inline">memberships:facts:membership_created</code></li><li><code class="inline">memberships:facts:membership_expired</code></li></ul><h3 id="benefits-of-this-pattern" class="section-heading"><a href="#benefits-of-this-pattern" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Benefits of This Pattern</span></h3><ol><li><strong>Decoupling</strong>: Domains don't know about each other, only about facts</li><li><strong>Versioning</strong>: Facts can be versioned independently</li><li><strong>Selective Consumption</strong>: Domains subscribe only to events they care about</li><li><strong>Auditability</strong>: All integration events are explicitly defined as facts</li><li><strong>Testability</strong>: Fact publishing and consumption can be tested independently</li></ol><h2 id="web-ui-architecture" class="section-heading"><a href="#web-ui-architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Web UI Architecture</span></h2><h3 id="phoenix-liveview-preference" class="section-heading"><a href="#phoenix-liveview-preference" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phoenix LiveView Preference</span></h3><p><strong>Design Rule</strong>: Use Phoenix LiveView instead of classic MVC architecture for interactive web interfaces.</p><p><strong>✅ PREFERRED - LiveView architecture:</strong></p><ul><li>Real-time interactivity without JavaScript</li><li>Stateful user interfaces</li><li>Server-side rendering with client-side updates</li><li>Built-in handling of form validation and user feedback</li><li>Simplified state management</li></ul><p><strong>❌ AVOID - Classic MVC where LiveView is suitable:</strong></p><ul><li>Controllers for simple form handling</li><li>Multiple request/response cycles for interactive features</li><li>Client-side JavaScript for basic interactivity</li><li>Complex form validation handling</li></ul><h3 id="liveview-module-structure" class="section-heading"><a href="#liveview-module-structure" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">LiveView Module Structure</span></h3><pre><code class="makeup elixir" translate="no"><span class="c1"># lib/landing_site_web/live/auth_live.ex</span><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">LandingSiteWeb.AuthLive</span><span class="w"> </span><span class="k" data-group-id="7107000623-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">LandingSiteWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:live_view</span><span class="w">
  
  </span><span class="c1"># LiveView callbacks</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">mount</span><span class="p" data-group-id="7107000623-2">(</span><span class="c">_params</span><span class="p">,</span><span class="w"> </span><span class="c">_session</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="7107000623-2">)</span><span class="w"> </span><span class="k" data-group-id="7107000623-3">do</span><span class="w">
    </span><span class="c1"># Initialize socket state</span><span class="w">
  </span><span class="k" data-group-id="7107000623-3">end</span><span class="w">
  
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_event</span><span class="p" data-group-id="7107000623-4">(</span><span class="s">&quot;register&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7107000623-5">%{</span><span class="s">&quot;user&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">user_params</span><span class="p" data-group-id="7107000623-5">}</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="7107000623-4">)</span><span class="w"> </span><span class="k" data-group-id="7107000623-6">do</span><span class="w">
    </span><span class="c1"># Handle user registration</span><span class="w">
  </span><span class="k" data-group-id="7107000623-6">end</span><span class="w">
  
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_event</span><span class="p" data-group-id="7107000623-7">(</span><span class="s">&quot;login&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7107000623-8">%{</span><span class="s">&quot;user&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">user_params</span><span class="p" data-group-id="7107000623-8">}</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="7107000623-7">)</span><span class="w"> </span><span class="k" data-group-id="7107000623-9">do</span><span class="w">
    </span><span class="c1"># Handle user authentication</span><span class="w">
  </span><span class="k" data-group-id="7107000623-9">end</span><span class="w">
  
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">render</span><span class="p" data-group-id="7107000623-10">(</span><span class="n">assigns</span><span class="p" data-group-id="7107000623-10">)</span><span class="w"> </span><span class="k" data-group-id="7107000623-11">do</span><span class="w">
    </span><span class="c1"># Render the LiveView template</span><span class="w">
  </span><span class="k" data-group-id="7107000623-11">end</span><span class="w">
</span><span class="k" data-group-id="7107000623-1">end</span></code></pre><h3 id="when-to-use-classic-mvc" class="section-heading"><a href="#when-to-use-classic-mvc" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">When to Use Classic MVC</span></h3><p><strong>Acceptable use cases for Controllers:</strong></p><ul><li>API endpoints (JSON responses)</li><li>Simple redirects or downloads</li><li>Authentication callbacks (OAuth, etc.)</li><li>Webhook handlers</li><li>Static page rendering without interactivity</li></ul><h3 id="migration-from-mvc-to-liveview" class="section-heading"><a href="#migration-from-mvc-to-liveview" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Migration from MVC to LiveView</span></h3><p>Refactoring from classic MVC to LiveView is generally straightforward:</p><ol><li><strong>Controller actions</strong> → <strong>LiveView event handlers</strong></li><li><strong>Form submissions</strong> → <strong>LiveView events</strong></li><li><strong>Flash messages</strong> → <strong>LiveView assigns</strong></li><li><strong>Redirects</strong> → <strong>LiveView navigation</strong></li><li><strong>Template rendering</strong> → <strong>LiveView render function</strong></li></ol><p><strong>Example migration:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># Before: Classic MVC</span><span class="w">
</span><span class="kd">def</span><span class="w"> </span><span class="nf">create_account</span><span class="p" data-group-id="3940555637-1">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3940555637-2">%{</span><span class="s">&quot;user&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">user_params</span><span class="p" data-group-id="3940555637-2">}</span><span class="p" data-group-id="3940555637-1">)</span><span class="w"> </span><span class="k" data-group-id="3940555637-3">do</span><span class="w">
  </span><span class="k">case</span><span class="w"> </span><span class="nc">UserContext</span><span class="o">.</span><span class="n">register_user</span><span class="p" data-group-id="3940555637-4">(</span><span class="n">user_params</span><span class="p" data-group-id="3940555637-4">)</span><span class="w"> </span><span class="k" data-group-id="3940555637-5">do</span><span class="w">
    </span><span class="p" data-group-id="3940555637-6">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="3940555637-6">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="n">conn</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_flash</span><span class="p" data-group-id="3940555637-7">(</span><span class="ss">:info</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Account created successfully&quot;</span><span class="p" data-group-id="3940555637-7">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">redirect</span><span class="p" data-group-id="3940555637-8">(</span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="sx">~p&quot;/auth/login&quot;</span><span class="p" data-group-id="3940555637-8">)</span><span class="w">
    </span><span class="p" data-group-id="3940555637-9">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="3940555637-9">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="n">render</span><span class="p" data-group-id="3940555637-10">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:register</span><span class="p">,</span><span class="w"> </span><span class="ss">changeset</span><span class="p">:</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="3940555637-10">)</span><span class="w">
  </span><span class="k" data-group-id="3940555637-5">end</span><span class="w">
</span><span class="k" data-group-id="3940555637-3">end</span><span class="w">

</span><span class="c1"># After: LiveView</span><span class="w">
</span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_event</span><span class="p" data-group-id="3940555637-11">(</span><span class="s">&quot;register&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3940555637-12">%{</span><span class="s">&quot;user&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">user_params</span><span class="p" data-group-id="3940555637-12">}</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="3940555637-11">)</span><span class="w"> </span><span class="k" data-group-id="3940555637-13">do</span><span class="w">
  </span><span class="k">case</span><span class="w"> </span><span class="nc">UserContext</span><span class="o">.</span><span class="n">register_user</span><span class="p" data-group-id="3940555637-14">(</span><span class="n">user_params</span><span class="p" data-group-id="3940555637-14">)</span><span class="w"> </span><span class="k" data-group-id="3940555637-15">do</span><span class="w">
    </span><span class="p" data-group-id="3940555637-16">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="3940555637-16">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="n">socket</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_flash</span><span class="p" data-group-id="3940555637-17">(</span><span class="ss">:info</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Account created successfully&quot;</span><span class="p" data-group-id="3940555637-17">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">push_navigate</span><span class="p" data-group-id="3940555637-18">(</span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="sx">~p&quot;/auth/login&quot;</span><span class="p" data-group-id="3940555637-18">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">noreply</span><span class="p" data-group-id="3940555637-19">(</span><span class="p" data-group-id="3940555637-19">)</span><span class="w">
    </span><span class="p" data-group-id="3940555637-20">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="3940555637-20">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="n">socket</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="3940555637-21">(</span><span class="ss">:changeset</span><span class="p">,</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="3940555637-21">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">noreply</span><span class="p" data-group-id="3940555637-22">(</span><span class="p" data-group-id="3940555637-22">)</span><span class="w">
  </span><span class="k" data-group-id="3940555637-15">end</span><span class="w">
</span><span class="k" data-group-id="3940555637-13">end</span></code></pre><h2 id="reckon_app-integration-pattern" class="section-heading"><a href="#reckon_app-integration-pattern" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Reckon_App Integration Pattern</span></h2><h3 id="domainapi-architecture" class="section-heading"><a href="#domainapi-architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">DomainAPI Architecture</span></h3><p><strong>Design Rule</strong>: Each reckon_app owns a DomainAPI GenServer that provides the interface for external communication.</p><p><strong>Architecture Components:</strong></p><ol><li><p><strong>DomainAPI GenServer</strong>: Each reckon_app implements its own DomainAPI that:</p><ul><li>Registers itself in Swarm using <code class="inline">Swarm.register_name(api_name(), self())</code></li><li>Offers a user-friendly set of API functions for sending commands to the Domain</li><li>Handles <code class="inline">GenServer.cast</code> and <code class="inline">GenServer.call</code> callbacks</li><li>Uses pattern matching like <code class="inline">GenServer.cast(api_pid(), message)</code> to route messages</li></ul></li><li><p><strong>Service Registration</strong>: </p><pre><code class="makeup elixir" translate="no"><span class="c1"># In each reckon_app&#39;s DomainAPI</span><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ReckonProfiles.DomainAPI</span><span class="w"> </span><span class="k" data-group-id="9784296368-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">GenServer</span><span class="w">

  
  </span><span class="na">@domain_name</span><span class="w"> </span><span class="ss">:my_domain</span><span class="w">
  
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">api_name</span><span class="p" data-group-id="9784296368-2">(</span><span class="p" data-group-id="9784296368-2">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9784296368-3">{</span><span class="ss">:domain_api</span><span class="p">,</span><span class="w"> </span><span class="na">@domain_name</span><span class="p" data-group-id="9784296368-3">}</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">api_pid</span><span class="p" data-group-id="9784296368-4">(</span><span class="p" data-group-id="9784296368-4">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Swarm</span><span class="o">.</span><span class="n">whereis_name</span><span class="p" data-group-id="9784296368-5">(</span><span class="n">api_name</span><span class="p" data-group-id="9784296368-6">(</span><span class="p" data-group-id="9784296368-6">)</span><span class="p" data-group-id="9784296368-5">)</span><span class="w">
  
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">start_link</span><span class="p" data-group-id="9784296368-7">(</span><span class="n">opts</span><span class="p" data-group-id="9784296368-7">)</span><span class="w"> </span><span class="k" data-group-id="9784296368-8">do</span><span class="w">
    </span><span class="nc">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p" data-group-id="9784296368-9">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="bp">__MODULE__</span><span class="p" data-group-id="9784296368-9">)</span><span class="w">
  </span><span class="k" data-group-id="9784296368-8">end</span><span class="w">
  
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">init</span><span class="p" data-group-id="9784296368-10">(</span><span class="n">opts</span><span class="p" data-group-id="9784296368-10">)</span><span class="w"> </span><span class="k" data-group-id="9784296368-11">do</span><span class="w">
    </span><span class="c1"># Register this API with Swarm for discovery</span><span class="w">
    </span><span class="nc">Swarm</span><span class="o">.</span><span class="n">register_name</span><span class="p" data-group-id="9784296368-12">(</span><span class="p" data-group-id="9784296368-13">{</span><span class="ss">:domain_api</span><span class="p">,</span><span class="w"> </span><span class="ss">:reckon_profiles</span><span class="p" data-group-id="9784296368-13">}</span><span class="p">,</span><span class="w"> </span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9784296368-14">[</span><span class="p" data-group-id="9784296368-14">]</span><span class="p" data-group-id="9784296368-12">)</span><span class="w">
    </span><span class="p" data-group-id="9784296368-15">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p" data-group-id="9784296368-15">}</span><span class="w">
  </span><span class="k" data-group-id="9784296368-11">end</span><span class="w">
  
  </span><span class="c1"># User-friendly API functions</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">establish_profile</span><span class="p" data-group-id="9784296368-16">(</span><span class="n">account_id</span><span class="p">,</span><span class="w"> </span><span class="n">display_name</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="9784296368-16">)</span><span class="w"> </span><span class="k" data-group-id="9784296368-17">do</span><span class="w">
    </span><span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="9784296368-18">%</span><span class="nc" data-group-id="9784296368-18">ReckonProfiles.EstablishProfile.Command</span><span class="p" data-group-id="9784296368-18">{</span><span class="w">
      </span><span class="ss">account_id</span><span class="p">:</span><span class="w"> </span><span class="n">account_id</span><span class="p">,</span><span class="w">
      </span><span class="ss">display_name</span><span class="p">:</span><span class="w"> </span><span class="n">display_name</span><span class="p">,</span><span class="w">
      </span><span class="ss">bio</span><span class="p">:</span><span class="w"> </span><span class="n">bio</span><span class="p">,</span><span class="w">
      </span><span class="ss">requested_at</span><span class="p">:</span><span class="w"> </span><span class="nc">DateTime</span><span class="o">.</span><span class="n">utc_now</span><span class="p" data-group-id="9784296368-19">(</span><span class="p" data-group-id="9784296368-19">)</span><span class="w">
    </span><span class="p" data-group-id="9784296368-18">}</span><span class="w">
    
    </span><span class="nc">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p" data-group-id="9784296368-20">(</span><span class="n">api_pid</span><span class="p" data-group-id="9784296368-21">(</span><span class="p" data-group-id="9784296368-21">)</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9784296368-22">{</span><span class="ss">:dispatch_command</span><span class="p">,</span><span class="w"> </span><span class="n">command</span><span class="p" data-group-id="9784296368-22">}</span><span class="p" data-group-id="9784296368-20">)</span><span class="w">
  </span><span class="k" data-group-id="9784296368-17">end</span><span class="w">
  
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_call</span><span class="p" data-group-id="9784296368-23">(</span><span class="p" data-group-id="9784296368-24">{</span><span class="ss">:dispatch_command</span><span class="p">,</span><span class="w"> </span><span class="n">command</span><span class="p" data-group-id="9784296368-24">}</span><span class="p">,</span><span class="w"> </span><span class="c">_from</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="9784296368-23">)</span><span class="w"> </span><span class="k" data-group-id="9784296368-25">do</span><span class="w">
    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ReckonProfiles.CommandedApp</span><span class="o">.</span><span class="n">dispatch</span><span class="p" data-group-id="9784296368-26">(</span><span class="n">command</span><span class="p" data-group-id="9784296368-26">)</span><span class="w">
    </span><span class="p" data-group-id="9784296368-27">{</span><span class="ss">:reply</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="9784296368-27">}</span><span class="w">
  </span><span class="k" data-group-id="9784296368-25">end</span><span class="w">
</span><span class="k" data-group-id="9784296368-1">end</span></code></pre></li><li><p><strong>Landing Site Integration</strong>: </p><pre><code class="makeup elixir" translate="no"><span class="c1"># In landing_site mix.exs</span><span class="w">
</span><span class="kd">defp</span><span class="w"> </span><span class="nf">deps</span><span class="w"> </span><span class="k" data-group-id="8572403142-1">do</span><span class="w">
  </span><span class="p" data-group-id="8572403142-2">[</span><span class="w">
    </span><span class="c1"># Add each reckon_app as dependency without starting the application</span><span class="w">
    </span><span class="p" data-group-id="8572403142-3">{</span><span class="ss">:reckon_accounts</span><span class="p">,</span><span class="w"> </span><span class="ss">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;../reckon_apps/reckon_accounts/&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">application</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p" data-group-id="8572403142-3">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="8572403142-4">{</span><span class="ss">:reckon_profiles</span><span class="p">,</span><span class="w"> </span><span class="ss">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;../reckon_apps/reckon_profiles/&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">application</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p" data-group-id="8572403142-4">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="8572403142-5">{</span><span class="ss">:reckon_memberships</span><span class="p">,</span><span class="w"> </span><span class="ss">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;../reckon_apps/reckon_memberships/&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">application</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p" data-group-id="8572403142-5">}</span><span class="w">
  </span><span class="p" data-group-id="8572403142-2">]</span><span class="w">
</span><span class="k" data-group-id="8572403142-1">end</span></code></pre></li><li><p><strong>LibCluster Configuration</strong>: All services use the same cluster configuration to enable service discovery:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># In each reckon_app&#39;s config/config.exs</span><span class="w">
</span><span class="n">config</span><span class="w"> </span><span class="ss">:libcluster</span><span class="p">,</span><span class="w">
  </span><span class="ss">topologies</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4762451168-1">[</span><span class="w">
    </span><span class="ss">reckon_cluster</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4762451168-2">[</span><span class="w">
      </span><span class="ss">strategy</span><span class="p">:</span><span class="w"> </span><span class="nc">Cluster.Strategy.Gossip</span><span class="p">,</span><span class="w">
      </span><span class="ss">config</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4762451168-3">[</span><span class="w">
        </span><span class="ss">port</span><span class="p">:</span><span class="w"> </span><span class="mi">45_890</span><span class="p">,</span><span class="w">  </span><span class="c1"># Shared port for all reckon services</span><span class="w">
        </span><span class="ss">if_addr</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0.0.0.0&quot;</span><span class="p">,</span><span class="w">
        </span><span class="ss">multicast_addr</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;230.1.1.251&quot;</span><span class="p">,</span><span class="w">
        </span><span class="ss">multicast_ttl</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="ss">secret</span><span class="p">:</span><span class="w"> </span><span class="nc">System</span><span class="o">.</span><span class="n">get_env</span><span class="p" data-group-id="4762451168-4">(</span><span class="s">&quot;RECKON_CLUSTER_SECRET&quot;</span><span class="p" data-group-id="4762451168-4">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s">&quot;reckon_cluster_dev_secret&quot;</span><span class="w">
      </span><span class="p" data-group-id="4762451168-3">]</span><span class="w">
    </span><span class="p" data-group-id="4762451168-2">]</span><span class="w">
  </span><span class="p" data-group-id="4762451168-1">]</span></code></pre></li></ol><h3 id="benefits-of-this-pattern-1" class="section-heading"><a href="#benefits-of-this-pattern-1" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Benefits of This Pattern</span></h3><ol><li><strong>Domain Ownership</strong>: Each reckon_app owns its API boundary and communication protocol</li><li><strong>Service Discovery</strong>: Swarm provides automatic service discovery across the cluster</li><li><strong>Fault Tolerance</strong>: Services can be started/stopped independently</li><li><strong>Clean Dependencies</strong>: Landing site depends on reckon_apps for compilation but not runtime</li><li><strong>Scalability</strong>: Multiple instances of each reckon_app can be deployed</li><li><strong>LibCluster Integration</strong>: Follows the preferred clustering approach over seed_nodes</li></ol><h3 id="implementation-checklist" class="section-heading"><a href="#implementation-checklist" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Implementation Checklist</span></h3><p><strong>For each reckon_app:</strong></p><ul><li>[ ] Implement DomainAPI GenServer with Swarm registration</li><li>[ ] Add user-friendly API functions that wrap CommandedApp.dispatch calls</li><li>[ ] Configure libcluster with shared cluster settings</li><li>[ ] Add libcluster and swarm dependencies</li><li>[ ] Update Application supervision tree to start DomainAPI</li></ul><p><strong>For landing_site:</strong></p><ul><li>[ ] Add reckon_apps as <code class="inline">application: false</code> dependencies</li><li>[ ] Implement service discovery to find available DomainAPIs</li><li>[ ] Configure libcluster to join the same cluster</li><li>[ ] Create communication layer that uses Swarm.whereis_name to find services</li></ul><h2 id="anti-patterns-to-avoid" class="section-heading"><a href="#anti-patterns-to-avoid" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Anti-Patterns to Avoid</span></h2><ol><li><strong>❌ Grouping by technical layer</strong> (controllers/, services/, models/)</li><li><strong>❌ Shared command/event modules</strong> (mixing multiple operations)</li><li><strong>❌ Generic naming</strong> (using technical terms instead of business terms)</li><li><strong>❌ Horizontal slicing</strong> (splitting one business operation across multiple technical layers)</li><li><strong>❌ Anemic domain models</strong> (putting business logic in &quot;service&quot; classes)</li><li><strong>❌ Generic PubSub topics</strong> (using broad topics instead of event-specific ones)</li><li><strong>❌ Direct domain coupling</strong> (one domain importing modules from another)</li><li><strong>❌ Mixing domain events with integration facts</strong> (using same struct for both)</li><li><strong>❌ CRUD-based event naming</strong> (using generic -created, -updated, -deleted instead of meaningful business events)</li><li><strong>❌ Direct Router usage</strong> (bypassing CommandedApp for command dispatch)</li><li><strong>❌ Multiple capabilities per module</strong> (violating 1-capability-per-module rule)</li><li><strong>❌ Incorrect projection naming</strong> (not following <code class="inline">&lt;event&gt;_to_&lt;readmodel&gt;.ex</code> format)</li><li><strong>❌ Policies bypassing CommandedApp</strong> (direct command creation without proper dispatch)</li></ol><h3 id="forbidden-direct-router-usage-for-command-dispatch" class="section-heading"><a href="#forbidden-direct-router-usage-for-command-dispatch" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">🚫 FORBIDDEN: Direct Router Usage for Command Dispatch</span></h3><p><strong>This anti-pattern is FORBIDDEN in all reckon_* applications.</strong></p><p><strong>❌ BAD - Direct Router usage:</strong></p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ReckonProfiles</span><span class="w"> </span><span class="k" data-group-id="3030347642-1">do</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">ReckonProfiles.Router</span><span class="w">  </span><span class="c1"># 🚫 FORBIDDEN</span><span class="w">
  
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">create_profile</span><span class="p" data-group-id="3030347642-2">(</span><span class="n">account_id</span><span class="p">,</span><span class="w"> </span><span class="n">display_name</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p" data-group-id="3030347642-2">)</span><span class="w"> </span><span class="k" data-group-id="3030347642-3">do</span><span class="w">
    </span><span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="3030347642-4">%</span><span class="nc" data-group-id="3030347642-4">ReckonProfiles.CreateProfile.Command</span><span class="p" data-group-id="3030347642-4">{</span><span class="w">
      </span><span class="ss">account_id</span><span class="p">:</span><span class="w"> </span><span class="n">account_id</span><span class="p">,</span><span class="w">
      </span><span class="ss">display_name</span><span class="p">:</span><span class="w"> </span><span class="n">display_name</span><span class="p">,</span><span class="w">
      </span><span class="ss">bio</span><span class="p">:</span><span class="w"> </span><span class="n">bio</span><span class="p">,</span><span class="w">
      </span><span class="ss">requested_at</span><span class="p">:</span><span class="w"> </span><span class="nc">DateTime</span><span class="o">.</span><span class="n">utc_now</span><span class="p" data-group-id="3030347642-5">(</span><span class="p" data-group-id="3030347642-5">)</span><span class="w">
    </span><span class="p" data-group-id="3030347642-4">}</span><span class="w">
    
    </span><span class="nc">Router</span><span class="o">.</span><span class="n">dispatch</span><span class="p" data-group-id="3030347642-6">(</span><span class="n">command</span><span class="p" data-group-id="3030347642-6">)</span><span class="w">  </span><span class="c1"># 🚫 FORBIDDEN - bypasses CommandedApp</span><span class="w">
  </span><span class="k" data-group-id="3030347642-3">end</span><span class="w">
</span><span class="k" data-group-id="3030347642-1">end</span></code></pre><p><strong>✅ CORRECT - CommandedApp usage:</strong></p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ReckonProfiles</span><span class="w"> </span><span class="k" data-group-id="2104030316-1">do</span><span class="w">
  </span><span class="kn">alias</span><span class="w"> </span><span class="nc">ReckonProfiles.CommandedApp</span><span class="w">  </span><span class="c1"># ✅ CORRECT</span><span class="w">
  
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">create_profile</span><span class="p" data-group-id="2104030316-2">(</span><span class="n">account_id</span><span class="p">,</span><span class="w"> </span><span class="n">display_name</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p" data-group-id="2104030316-2">)</span><span class="w"> </span><span class="k" data-group-id="2104030316-3">do</span><span class="w">
    </span><span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="2104030316-4">%</span><span class="nc" data-group-id="2104030316-4">ReckonProfiles.CreateProfile.Command</span><span class="p" data-group-id="2104030316-4">{</span><span class="w">
      </span><span class="ss">account_id</span><span class="p">:</span><span class="w"> </span><span class="n">account_id</span><span class="p">,</span><span class="w">
      </span><span class="ss">display_name</span><span class="p">:</span><span class="w"> </span><span class="n">display_name</span><span class="p">,</span><span class="w">
      </span><span class="ss">bio</span><span class="p">:</span><span class="w"> </span><span class="n">bio</span><span class="p">,</span><span class="w">
      </span><span class="ss">requested_at</span><span class="p">:</span><span class="w"> </span><span class="nc">DateTime</span><span class="o">.</span><span class="n">utc_now</span><span class="p" data-group-id="2104030316-5">(</span><span class="p" data-group-id="2104030316-5">)</span><span class="w">
    </span><span class="p" data-group-id="2104030316-4">}</span><span class="w">
    
    </span><span class="nc">CommandedApp</span><span class="o">.</span><span class="n">dispatch</span><span class="p" data-group-id="2104030316-6">(</span><span class="n">command</span><span class="p" data-group-id="2104030316-6">)</span><span class="w">  </span><span class="c1"># ✅ CORRECT - goes through CommandedApp</span><span class="w">
  </span><span class="k" data-group-id="2104030316-3">end</span><span class="w">
</span><span class="k" data-group-id="2104030316-1">end</span></code></pre><p><strong>Why this rule exists:</strong></p><ol><li><strong>Architectural Consistency</strong>: CommandedApp is the proper entry point for commands in Commanded</li><li><strong>Centralized Configuration</strong>: CommandedApp handles event store config, middleware, and other application-level concerns</li><li><strong>Middleware Support</strong>: CommandedApp can add middleware for logging, validation, authentication, etc.</li><li><strong>Error Handling</strong>: Provides consistent error handling and retry logic across all commands</li><li><strong>Testing</strong>: Easier to mock CommandedApp than individual router calls</li><li><strong>Future-Proofing</strong>: Easier to add cross-cutting concerns like audit logging, metrics, etc.</li><li><strong>Commanded Best Practices</strong>: <code class="inline">CommandedApp.dispatch()</code> is the idiomatic way in Commanded</li></ol><p><strong>Command Flow:</strong></p><pre><code class="makeup elixir" translate="no"><span class="nc">Business</span><span class="w"> </span><span class="nc">Logic</span><span class="w"> </span><span class="p" data-group-id="7738850231-1">(</span><span class="nc">ReckonProfiles</span><span class="o">.</span><span class="n">ex</span><span class="p" data-group-id="7738850231-1">)</span><span class="w">
         </span><span class="err">↓</span><span class="w">
  </span><span class="nc">CommandedApp</span><span class="o">.</span><span class="n">dispatch</span><span class="p" data-group-id="7738850231-2">(</span><span class="p" data-group-id="7738850231-2">)</span><span class="w">  </span><span class="err">✅</span><span class="w"> </span><span class="nc">CORRECT</span><span class="w">
         </span><span class="err">↓</span><span class="w">
    </span><span class="nc">Router</span><span class="w"> </span><span class="p" data-group-id="7738850231-3">(</span><span class="n">internal</span><span class="w"> </span><span class="n">routing</span><span class="p" data-group-id="7738850231-3">)</span><span class="w">
         </span><span class="err">↓</span><span class="w">
  </span><span class="nc">Handler</span><span class="w"> </span><span class="p" data-group-id="7738850231-4">(</span><span class="n">processes</span><span class="w"> </span><span class="n">command</span><span class="p" data-group-id="7738850231-4">)</span><span class="w">
         </span><span class="err">↓</span><span class="w">
    </span><span class="nc">Events</span><span class="w"> </span><span class="p" data-group-id="7738850231-5">(</span><span class="n">domain</span><span class="w"> </span><span class="n">events</span><span class="p" data-group-id="7738850231-5">)</span></code></pre><p><strong>NOT:</strong></p><pre><code class="makeup elixir" translate="no"><span class="nc">Business</span><span class="w"> </span><span class="nc">Logic</span><span class="w"> </span><span class="p" data-group-id="2040568103-1">(</span><span class="nc">ReckonProfiles</span><span class="o">.</span><span class="n">ex</span><span class="p" data-group-id="2040568103-1">)</span><span class="w">
         </span><span class="err">↓</span><span class="w">
    </span><span class="nc">Router</span><span class="o">.</span><span class="n">dispatch</span><span class="p" data-group-id="2040568103-2">(</span><span class="p" data-group-id="2040568103-2">)</span><span class="w">  </span><span class="err">🚫</span><span class="w"> </span><span class="nc">FORBIDDEN</span><span class="w">
         </span><span class="err">↓</span><span class="w">
  </span><span class="nc">Handler</span><span class="w"> </span><span class="p" data-group-id="2040568103-3">(</span><span class="n">processes</span><span class="w"> </span><span class="n">command</span><span class="p" data-group-id="2040568103-3">)</span><span class="w">
         </span><span class="err">↓</span><span class="w">
    </span><span class="nc">Events</span><span class="w"> </span><span class="p" data-group-id="2040568103-4">(</span><span class="n">domain</span><span class="w"> </span><span class="n">events</span><span class="p" data-group-id="2040568103-4">)</span></code></pre><p><strong>The Router is an internal implementation detail that should NEVER be called directly from business logic.</strong></p><h3 id="crud-events-vs-business-events" class="section-heading"><a href="#crud-events-vs-business-events" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">CRUD Events vs Business Events</span></h3><p><strong>❌ BAD - CRUD-focused event names:</strong></p><ul><li><code class="inline">ProfileCreated</code></li><li><code class="inline">ProfileUpdated</code> </li><li><code class="inline">ProfileDeleted</code></li><li><code class="inline">AccountCreated</code></li><li><code class="inline">AccountUpdated</code></li><li><code class="inline">MembershipCreated</code></li></ul><p><strong>✅ GOOD - Business-focused event names:</strong></p><ul><li><code class="inline">ProfileEstablished</code> (when user completes initial profile setup)</li><li><code class="inline">ProfilePersonalized</code> (when user customizes their profile)</li><li><code class="inline">ProfileDeactivated</code> (when user temporarily hides their profile)</li><li><code class="inline">AccountInitialized</code> (when registration begins)</li><li><code class="inline">AccountActivated</code> (when email is verified)</li><li><code class="inline">AccountSuspended</code> (when account is temporarily disabled)</li><li><code class="inline">AccountClosed</code> (when account is permanently closed)</li><li><code class="inline">TrialMembershipGranted</code> (when free trial begins)</li><li><code class="inline">PremiumMembershipUpgraded</code> (when user pays for premium)</li><li><code class="inline">MembershipExpired</code> (when subscription ends)</li></ul><p><strong>Why this matters:</strong></p><ul><li>Business events capture <strong>intent and meaning</strong>, not just state changes</li><li>They reflect the <strong>ubiquitous language</strong> of the domain</li><li>They enable <strong>better event sourcing</strong> by preserving business context</li><li>They make <strong>event streams readable</strong> as a business narrative</li><li>They support <strong>better analytics</strong> and business intelligence</li><li>They enable <strong>temporal queries</strong> that make business sense</li></ul><p><strong>Example of business context preservation:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># ❌ BAD - Generic CRUD event</span><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ReckonAccounts.AccountUpdated.Event</span><span class="w"> </span><span class="k" data-group-id="0528387902-1">do</span><span class="w">
  </span><span class="kd">defstruct</span><span class="w"> </span><span class="p" data-group-id="0528387902-2">[</span><span class="ss">:account_id</span><span class="p">,</span><span class="w"> </span><span class="ss">:changes</span><span class="p">,</span><span class="w"> </span><span class="ss">:updated_at</span><span class="p" data-group-id="0528387902-2">]</span><span class="w">
</span><span class="k" data-group-id="0528387902-1">end</span><span class="w">

</span><span class="c1"># ✅ GOOD - Meaningful business events</span><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ReckonAccounts.AccountActivated.Event</span><span class="w"> </span><span class="k" data-group-id="0528387902-3">do</span><span class="w">
  </span><span class="kd">defstruct</span><span class="w"> </span><span class="p" data-group-id="0528387902-4">[</span><span class="ss">:account_id</span><span class="p">,</span><span class="w"> </span><span class="ss">:email</span><span class="p">,</span><span class="w"> </span><span class="ss">:activated_at</span><span class="p">,</span><span class="w"> </span><span class="ss">:verification_token</span><span class="p" data-group-id="0528387902-4">]</span><span class="w">
</span><span class="k" data-group-id="0528387902-3">end</span><span class="w">

</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ReckonAccounts.AccountSuspended.Event</span><span class="w"> </span><span class="k" data-group-id="0528387902-5">do</span><span class="w">
  </span><span class="kd">defstruct</span><span class="w"> </span><span class="p" data-group-id="0528387902-6">[</span><span class="ss">:account_id</span><span class="p">,</span><span class="w"> </span><span class="ss">:reason</span><span class="p">,</span><span class="w"> </span><span class="ss">:suspended_at</span><span class="p">,</span><span class="w"> </span><span class="ss">:suspended_by</span><span class="p" data-group-id="0528387902-6">]</span><span class="w">
</span><span class="k" data-group-id="0528387902-5">end</span><span class="w">

</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ReckonAccounts.AccountClosed.Event</span><span class="w"> </span><span class="k" data-group-id="0528387902-7">do</span><span class="w">
  </span><span class="kd">defstruct</span><span class="w"> </span><span class="p" data-group-id="0528387902-8">[</span><span class="ss">:account_id</span><span class="p">,</span><span class="w"> </span><span class="ss">:reason</span><span class="p">,</span><span class="w"> </span><span class="ss">:closed_at</span><span class="p">,</span><span class="w"> </span><span class="ss">:requested_by</span><span class="p" data-group-id="0528387902-8">]</span><span class="w">
</span><span class="k" data-group-id="0528387902-7">end</span></code></pre><p>Remember: The codebase should <strong>scream</strong> what it does, not how it's implemented!</p>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="persistence-architecture.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Persistence Architecture
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="debugging.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Debugging and Troubleshooting
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/ex_esdb/0.6.0" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/ex_esdb/0.6.0">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/ex_esdb/0.6.0/show/guides/implementation-guidelines.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="ex_esdb.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.2) for the

          <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>

# YAML anchors for reusable templates

# Environment templates
x-dev-environment: &dev-env
  EX_ESDB_STORE_ID: "reg_gh"
  EX_ESDB_DB_TYPE: "cluster"
  EX_ESDB_TIMEOUT: "10000"
  EX_ESDB_COOKIE: ${REG_GH_CLIQUE}
  EX_ESDB_CLUSTER_SECRET: ${REG_GH_CLUSTER_SECRET}
  EX_ESDB_GOSSIP_MULTICAST_ADDR: ${REG_GH_GOSSIP_MULTICAST_ADDR}
  LOG_LEVEL: "debug"
  RUST_LOG: "debug"

x-prod-environment: &prod-env
  EX_ESDB_STORE_ID: "reg_gh"
  EX_ESDB_DB_TYPE: "cluster"
  EX_ESDB_TIMEOUT: "5000"
  EX_ESDB_COOKIE: ${REG_GH_CLIQUE}
  EX_ESDB_CLUSTER_SECRET: ${REG_GH_CLUSTER_SECRET}
  EX_ESDB_GOSSIP_MULTICAST_ADDR: ${REG_GH_GOSSIP_MULTICAST_ADDR}
  LOG_LEVEL: "info"
  RUST_LOG: "info"

# Resource constraints template (lighter for cluster3)
x-resource-limits: &resource-limits
  deploy:
    resources:
      limits:
        memory: 384M
        cpus: "0.4"
      reservations:
        memory: 192M
        cpus: "0.2"
    restart_policy:
      condition: on-failure
      delay: 5s
      max_attempts: 3
      window: 120s

# Logging configuration template
x-logging: &logging
  logging:
    driver: "json-file"
    options:
      max-size: "50m"
      max-file: "2"
      labels: "service,environment"

# Main service template
x-esdb-service: &esdb-service
  image: local/ex-esdb
  build:
    context: ../system
    args:
      - BUILD_ENV=development
  profiles:
    - cluster
  networks:
    - ex-esdb-net
  stop_grace_period: 30s
  environment:
    EX_ESDB_STORE_ID: "reg_gh"
    EX_ESDB_DB_TYPE: "cluster"
    EX_ESDB_TIMEOUT: "10000"
    EX_ESDB_COOKIE: ${REG_GH_CLIQUE}
    EX_ESDB_CLUSTER_SECRET: ${REG_GH_CLUSTER_SECRET}
    EX_ESDB_GOSSIP_MULTICAST_ADDR: ${REG_GH_GOSSIP_MULTICAST_ADDR}
    RELEASE_COOKIE: ${REG_GH_CLIQUE}
    LOG_LEVEL: "debug"
    RUST_LOG: "debug"
  deploy:
    resources:
      limits:
        memory: 384M
        cpus: "0.4"
      reservations:
        memory: 192M
        cpus: "0.2"
    restart_policy:
      condition: on-failure
      delay: 5s
      max_attempts: 3
      window: 120s
  healthcheck:
    test: ["CMD", "/system/check-ex-esdb.sh"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 40s
  logging:
    driver: "json-file"
    options:
      max-size: "50m"
      max-file: "2"
      labels: "service,environment"
  labels:
    - "service=ex-esdb"
    - "environment=development"
    - "cluster=tertiary"

# Dependency condition template
x-health-condition: &health-condition
  condition: service_healthy

services:
  # Massive cluster: Core + Extended + 8 additional nodes
  ex-esdb20:
    <<: *esdb-service
    hostname: node20
    container_name: ex-esdb20
    volumes:
      - ex-esdb20-data:/data
    labels:
      - "service=ex-esdb"
      - "environment=development"
      - "cluster=massive"
      - "group=massive"
      - "tier=massive"

  ex-esdb21:
    <<: *esdb-service
    hostname: node21
    container_name: ex-esdb21
    volumes:
      - ex-esdb21-data:/data
    labels:
      - "service=ex-esdb"
      - "environment=development"
      - "cluster=massive"
      - "group=massive"
      - "tier=massive"

  ex-esdb22:
    <<: *esdb-service
    hostname: node22
    container_name: ex-esdb22
    volumes:
      - ex-esdb22-data:/data
    labels:
      - "service=ex-esdb"
      - "environment=development"
      - "cluster=massive"
      - "group=massive"
      - "tier=massive"

  ex-esdb23:
    <<: *esdb-service
    hostname: node23
    container_name: ex-esdb23
    volumes:
      - ex-esdb23-data:/data
    labels:
      - "service=ex-esdb"
      - "environment=development"
      - "cluster=massive"
      - "group=massive"
      - "tier=massive"

  ex-esdb24:
    <<: *esdb-service
    hostname: node24
    container_name: ex-esdb24
    volumes:
      - ex-esdb24-data:/data
    labels:
      - "service=ex-esdb"
      - "environment=development"
      - "cluster=massive"
      - "group=massive"
      - "tier=massive"

  ex-esdb25:
    <<: *esdb-service
    hostname: node25
    container_name: ex-esdb25
    volumes:
      - ex-esdb25-data:/data
    labels:
      - "service=ex-esdb"
      - "environment=development"
      - "cluster=massive"
      - "group=massive"
      - "tier=massive"

  ex-esdb26:
    <<: *esdb-service
    hostname: node26
    container_name: ex-esdb26
    volumes:
      - ex-esdb26-data:/data
    labels:
      - "service=ex-esdb"
      - "environment=development"
      - "cluster=massive"
      - "group=massive"
      - "tier=massive"

  ex-esdb27:
    <<: *esdb-service
    hostname: node27
    container_name: ex-esdb27
    volumes:
      - ex-esdb27-data:/data
    labels:
      - "service=ex-esdb"
      - "environment=development"
      - "cluster=massive"
      - "group=massive"
      - "tier=massive"

networks:
  ex-esdb-net:
    external: true
    name: ex-esdb-net

volumes:
  ex-esdb20-data:
    driver: local
  ex-esdb21-data:
    driver: local
  ex-esdb22-data:
    driver: local
  ex-esdb23-data:
    driver: local
  ex-esdb24-data:
    driver: local
  ex-esdb25-data:
    driver: local
  ex-esdb26-data:
    driver: local
  ex-esdb27-data:
    driver: local
